<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bayview Counseling ‚Äî Lead Intelligence Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0B0E11; color: #E8ECF0; font-family: 'DM Sans', system-ui, sans-serif; }
    #loading {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; gap: 20px;
    }
    .spinner {
      width: 48px; height: 48px; border: 3px solid #1E2630;
      border-top-color: #3ECFB4; border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .load-text { color: #8899AA; font-size: 14px; }
    .error-box {
      background: #1a1010; border: 1px solid #E85D75; border-radius: 12px;
      padding: 24px 32px; max-width: 480px; text-align: center;
    }
    .error-box h2 { color: #E85D75; margin-bottom: 8px; }
    .error-box p { color: #8899AA; font-size: 13px; }
    .error-box button {
      margin-top: 16px; padding: 8px 20px; background: #3ECFB4; color: #0B0E11;
      border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="root">
    <div id="loading">
      <div class="spinner"></div>
      <div class="load-text">Loading dashboard data from Google Sheets‚Ä¶</div>
    </div>
  </div>

  <!-- React + Recharts from CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/prop-types@15/prop-types.min.js" crossorigin></script>
  <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-type="module">
    // ‚îÄ‚îÄ‚îÄ Globals from CDN ‚îÄ‚îÄ‚îÄ
    const { useState, useMemo, useEffect, useCallback } = React;
    const {
      BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer,
      PieChart, Pie, Cell, LineChart, Line, CartesianGrid, Legend,
      AreaChart, Area, ComposedChart
    } = Recharts;

    // ‚îÄ‚îÄ‚îÄ Data will be loaded from API ‚îÄ‚îÄ‚îÄ
    let PRECOMPUTED = null;

    // ‚îÄ‚îÄ‚îÄ DASHBOARD UI CODE ‚îÄ‚îÄ‚îÄ
    // ‚îÄ‚îÄ‚îÄ PALETTE ‚îÄ‚îÄ‚îÄ
const C = {
  bg: "#0B0E11", card: "#13171C", cardHover: "#1A1F26",
  border: "#1E2630", borderLight: "#2A3441",
  text: "#E8ECF0", textMuted: "#8899AA", textDim: "#556677",
  accent: "#3ECFB4", accentDim: "#2BA08A", accentGlow: "rgba(62,207,180,0.15)",
  warm: "#F0A050", warmDim: "#C07830",
  rose: "#E85D75", roseDim: "#B84058",
  blue: "#5B8DEF", blueDim: "#4070C0",
  purple: "#9B72CF", purpleDim: "#7855A8",
};
const CHART_COLORS = ["#3ECFB4","#F0A050","#5B8DEF","#E85D75","#9B72CF","#70D4A0","#E8C547","#CF72A0","#72B8CF","#CF9B72"];
const LOC_COLORS = { "Fort Lauderdale": "#3ECFB4", "Coral Springs": "#5B8DEF", "Plantation": "#F0A050", "Telehealth": "#9B72CF", "Unknown": "#556677", "Referred Out": "#E85D75" };

const COST_PER_LEAD = 150;
const ROOM_RENTAL = 40;
const AVG_SESSIONS = 3;
const THERAPY_REV = ROOM_RENTAL * AVG_SESSIONS;
const TESTING_REV = 1500;
const fmtCurrency = (n) => `$${n.toLocaleString()}`;
const fmtDate = (d) => new Date(d).toLocaleDateString("en-US", { month: "short", day: "numeric" });
const fmtDateFull = (d) => new Date(d).toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" });
const fmtMonth = (m) => { const [y, mo] = m.split("-"); return new Date(parseInt(y), parseInt(mo)-1).toLocaleDateString("en-US", { month: "short", year: "2-digit" }); };

const Tip = ({ active, payload, label }) => {
  if (!active || !payload?.length) return null;
  return (
    <div style={{ background: C.card, border: `1px solid ${C.border}`, borderRadius: 8, padding: "10px 14px", boxShadow: "0 8px 32px rgba(0,0,0,0.4)" }}>
      <p style={{ color: C.textMuted, fontSize: 11, margin: 0, marginBottom: 4 }}>{label}</p>
      {payload.map((p, i) => (
        <p key={i} style={{ color: p.color || C.accent, fontSize: 13, margin: 0, fontWeight: 600 }}>{p.name}: {typeof p.value === "number" ? p.value.toLocaleString() : p.value}</p>
      ))}
    </div>
  );
};

const StatCard = ({ label, value, icon, color, sub, trend, prev, prevLabel }) => (
  <div style={{ background: C.card, border: `1px solid ${C.border}`, borderRadius: 14, padding: "18px 20px", position: "relative", overflow: "hidden", transition: "all 0.2s" }}>
    <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 2, background: `linear-gradient(90deg, ${color}60, transparent)` }} />
    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
      <div>
        <p style={{ fontSize: 10, textTransform: "uppercase", letterSpacing: 1.2, color: C.textMuted, margin: 0, fontWeight: 600 }}>{label}</p>
        <p style={{ fontSize: 26, fontWeight: 800, margin: "6px 0 0", color: C.text, letterSpacing: -1, lineHeight: 1 }}>{typeof value === "number" ? value.toLocaleString() : value}</p>
        {sub && <p style={{ fontSize: 11, color: C.textMuted, margin: "4px 0 0" }}>{sub}</p>}
        {trend && <p style={{ fontSize: 11, color: trend.startsWith("‚Üë") ? C.accent : C.rose, margin: "4px 0 0", fontWeight: 600 }}>{trend}</p>}
        {prev !== undefined && prev !== null && (() => {
          const cur = typeof value === "number" ? value : parseFloat(String(value).replace(/[^0-9.-]/g, ''));
          const diff = cur - prev;
          const pct = prev > 0 ? Math.round((diff / prev) * 100) : (cur > 0 ? 100 : 0);
          const up = diff >= 0;
          return <p style={{ fontSize: 11, color: up ? C.accent : C.rose, margin: "4px 0 0", fontWeight: 600 }}>{up ? "‚ñ≤" : "‚ñº"} {Math.abs(diff).toLocaleString()} ({up ? "+" : ""}{pct}%) {prevLabel || "vs prior"}</p>;
        })()}
      </div>
      <span style={{ fontSize: 22, opacity: 0.7 }}>{icon}</span>
    </div>
  </div>
);

const ChartCard = ({ title, subtitle, children, style }) => (
  <div style={{ background: C.card, border: `1px solid ${C.border}`, borderRadius: 14, padding: "20px 22px", ...style }}>
    {title && <h3 style={{ fontSize: 14, fontWeight: 700, color: C.text, margin: 0 }}>{title}</h3>}
    {subtitle && <p style={{ fontSize: 11, color: C.textMuted, margin: "2px 0 14px" }}>{subtitle}</p>}
    {children}
  </div>
);

const RankRow = ({ rank, name, count, max, color, booked, rate, cost, revenue }) => (
  <div style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 0", borderBottom: `1px solid ${C.border}20` }}>
    <div style={{ width: 28, height: 28, borderRadius: 8, background: rank <= 3 ? `${color}20` : C.bg, display: "flex", alignItems: "center", justifyContent: "center", fontSize: rank <= 3 ? 14 : 11, fontWeight: 700, color: rank <= 3 ? color : C.textMuted, flexShrink: 0 }}>
      {rank === 1 ? "ü•á" : rank === 2 ? "ü•à" : rank === 3 ? "ü•â" : rank}
    </div>
    <div style={{ flex: 1, minWidth: 0 }}>
      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 3 }}>
        <span style={{ fontSize: 12, fontWeight: 600, color: C.text, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{name}</span>
        <span style={{ fontSize: 11, color: C.textMuted, flexShrink: 0, marginLeft: 8 }}>{count} leads ¬∑ {booked || 0} booked ¬∑ {rate || 0}%</span>
      </div>
      <div style={{ height: 4, background: C.bg, borderRadius: 2, overflow: "hidden" }}>
        <div style={{ height: "100%", width: `${Math.min(100, (count / max) * 100)}%`, background: `linear-gradient(90deg, ${color}, ${color}80)`, borderRadius: 2, transition: "width 0.6s ease" }} />
      </div>
    </div>
  </div>
);

function BayviewDashboard() {
  const [timeFilter, setTimeFilter] = useState("month");

        // Lead Intake state
        const [intakeForm, setIntakeForm] = useState({
          date: new Date().toISOString().split('T')[0],
          location: '', first_name: '', last_name: '', phone: '', email: '',
          service_type: '', presenting_problem: '', referral_source: '',
          action_taken: '', referred_to: '', marketing_program: 'No',
          referral_outcome: '', notes: ''
        });
        const [intakeMsg, setIntakeMsg] = useState(null);
        const [pendingLeads, setPendingLeads] = useState([]);
        const [loadingPending, setLoadingPending] = useState(false);
        const [recentLeads, setRecentLeads] = useState([]);
        const [loadingRecent, setLoadingRecent] = useState(false);
        const [editingLeadId, setEditingLeadId] = useState(null);
        const [leadRefreshKey, setLeadRefreshKey] = useState(0);
        const [dataVersion, setDataVersion] = useState(0);
  const [sessionsData, setSessionsData] = useState(null);
  const [sessionsLoading, setSessionsLoading] = useState(false);
  const [sessionsWeekIdx, setSessionsWeekIdx] = useState(null);
  const [sessionsExpanded, setSessionsExpanded] = useState({});

    // Rental Input state
    

        // Auto-calculate Monday-Sunday week dates
        const getAutoWeekDates = () => {
          const today = new Date();
          const day = today.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
          let weekMonday = new Date(today);
          if (day >= 2) {
            // Tuesday through Saturday: show current week's Mon-Sun
            weekMonday.setDate(today.getDate() - (day - 1));
          } else if (day === 1) {
            // Monday: show PRIOR week's Mon-Sun (for assistant to enter)
            weekMonday.setDate(today.getDate() - 7);
          } else {
            // Sunday (day=0): show prior week's Mon-Sun
            weekMonday.setDate(today.getDate() - 6);
          }
          const weekSunday = new Date(weekMonday);
          weekSunday.setDate(weekMonday.getDate() + 6);
          const fmt = (d) => d.toISOString().split('T')[0];
          return { week_start: fmt(weekMonday), week_end: fmt(weekSunday) };
        };

        // Combined list of therapist names for rental input dropdown
        const RENTAL_THERAPISTS = [
          "Adelle F.", "Alex S.", "Alexa V.", "Alyssa W.", "Carla B.", "Claire C.",
          "David S.", "Dr Jeffrey", "Heather D.", "Jackie S.", "Jamie R.",
          "Jnay R.", "Jonathan Stiglich", "Jorge H.", "Kacee T.", "Maria C",
          "Nicole A.", "Nicole G.", "Sara S.", "Seychelle S.", "Tahnnee M.",
          "Tatiana St.", "Taylor P.", "Valeria S.",
          "Dr. Heather V", "Dr. Heather K", "Simone F", "Kimberly G",
          "Dr. Brittany", "BTI Nova", "Jessica C", "Crystal A",
          "Dr Michael Collins", "Lorena A", "Dr. Halle S"
        ].sort();

        const [rentalForm, setRentalForm] = useState(() => {
          const autoWeek = getAutoWeekDates();
          return {
            week_start: autoWeek.week_start,
            week_end: autoWeek.week_end,
            entries: [{ therapist: '', location: 'FTL', amount_room: '', amount_mkt: '', amount_test: '', notes: '', sessions: '' }]
          };
        });
    const [rentalMsg, setRentalMsg] = useState(null);
    const [rentalWeekEntries, setRentalWeekEntries] = useState([]);
    const [rentalLoadingEntries, setRentalLoadingEntries] = useState(false);
    const [editingRentalWeek, setEditingRentalWeek] = useState(null);

    // Session data cache for rental auto-population
    const [rentalSessionsCache, setRentalSessionsCache] = React.useState(null);
    const [rentalSessionsLoading, setRentalSessionsLoading] = React.useState(false);

    // Map full location names to rental codes
    const LOCATION_REVERSE = {'Coral Springs':'CS','Fort Lauderdale':'FTL','Plantation':'PL','Telehealth':'FTL'};

    // Match rental dropdown name to session therapist name
    const matchTherapistToSession = (rentalName, sessionSummary) => {
      if (!rentalName || !sessionSummary) return null;
      const rn = rentalName.toLowerCase().replace(/[^a-z]/g, '');
      let best = null, bestScore = 0;
      for (const t of sessionSummary) {
        const sn = t.therapist.toLowerCase().replace(/[^a-z]/g, '');
        const snBase = sn.replace(/\*+$/, '');
        let score = 0;
        if (rn === snBase) score = 100;
        else if (rn.startsWith(snBase) || snBase.startsWith(rn)) score = 80;
        else { const rnFirst = rn.split(/[^a-z]/)[0]; const snFirst = snBase.split(/[^a-z]/)[0]; if (rnFirst.length >= 3 && snFirst.length >= 3 && (rnFirst.startsWith(snFirst) || snFirst.startsWith(rnFirst))) score = 60; }
        if (score > bestScore) { bestScore = score; best = t; }
      }
      return best;
    };

    // Fetch session data for rental auto-population
    const fetchRentalSessions = () => {
      console.log('[RENTAL] fetchRentalSessions called');
      if (rentalSessionsCache) return Promise.resolve(rentalSessionsCache);
      setRentalSessionsLoading(true);
      return fetch('/api/sessions?weeks=1')
        .then(r => r.json())
        .then(data => {
          console.log('[RENTAL] fetch resolved, data keys:', Object.keys(data));
          const summary = data.therapist_summary || [];
          setRentalSessionsCache(summary);
          setRentalSessionsLoading(false);
          return summary;
        })
        .catch(err => {
          console.error('Failed to fetch sessions:', err);
          setRentalSessionsLoading(false);
          return [];
        });
    };

    // Handle therapist selection - auto-populate location rows with session counts
    const handleTherapistSelect = (idx, value) => {
      console.log('[RENTAL] handleTherapistSelect called:', idx, value);
      updateRentalRow(idx, "therapist", value);
      if (!value) return;
      const doPopulate = (summary) => {
        const match = matchTherapistToSession(value, summary);
        if (!match || !match.by_location) return;
        const locs = Object.entries(match.by_location);
        if (locs.length === 0) return;
        const merged = {};
        for (const [loc, count] of locs) {
          const code = LOCATION_REVERSE[loc] || 'FTL';
          merged[code] = (merged[code] || 0) + count;
        }
        const locEntries = Object.entries(merged);
        console.log('[RENTAL] locEntries:', JSON.stringify(locEntries));
        setRentalForm(f => {
          console.log('[RENTAL] inside setRentalForm, f.entries:', f.entries.length);
          const newEntries = [...f.entries];
          newEntries[idx] = {...newEntries[idx], therapist: value, location: locEntries[0][0], sessions: String(locEntries[0][1])};
          for (let i = 1; i < locEntries.length; i++) {
            newEntries.splice(idx + i, 0, {therapist: value, location: locEntries[i][0], sessions: String(locEntries[i][1]), amount_room: '', amount_mkt: '', amount_test: '', notes: ''});
          }
          console.log('[RENTAL] newEntries sessions:', newEntries.map(e => e.sessions));
          return {...f, entries: newEntries};
        });
      };
      if (rentalSessionsCache) {
      console.log('[RENTAL] about to check cache, cache is:', rentalSessionsCache);
        doPopulate(rentalSessionsCache);
      } else {
        fetchRentalSessions().then(summary => doPopulate(summary));
      }
    };

    const RENTAL_LOCATIONS = ["FTL", "CS", "PL", "Testing", "MKT"];
    const RENTAL_CATEGORIES = ["room_rental", "marketing", "testing"];

    const addRentalRow = () => setRentalForm(f => ({...f, entries: [...f.entries, { therapist: '', location: 'FTL', amount_room: '', amount_mkt: '', amount_test: '', notes: '', sessions: '' }]}));
    const removeRentalRow = (idx) => setRentalForm(f => ({...f, entries: f.entries.filter((_, i) => i !== idx)}));
    const updateRentalRow = (idx, field, value) => setRentalForm(f => ({...f, entries: f.entries.map((ent, i) => i === idx ? {...ent, [field]: value} : ent)}));

    const loadRentalWeek = (ws, we) => {
      setRentalLoadingEntries(true);
      fetch("/api/rental/week?week_start=" + ws + (we ? "&week_end=" + we : ""))
        .then(r => r.json()).then(data => { setRentalWeekEntries(Array.isArray(data) ? data : []); setRentalLoadingEntries(false); })
        .catch(() => setRentalLoadingEntries(false));
    };

    const submitRental = () => {
      if (!rentalForm.week_start || !rentalForm.week_end) { setRentalMsg({type:"error",text:"Week start and end dates required"}); return; }
      const validEntries = [];
            rentalForm.entries.forEach(ent => {
              if (!ent.therapist) return;
              const roomAmt = parseFloat(ent.amount_room) || 0;
              const mktAmt = parseFloat(ent.amount_mkt) || 0;
              const testAmt = parseFloat(ent.amount_test) || 0;
              if (roomAmt > 0) validEntries.push({ therapist: ent.therapist, location: ent.location, amount: String(roomAmt), category: 'room_rental', notes: ent.notes });
              if (mktAmt > 0) validEntries.push({ therapist: ent.therapist, location: ent.location === 'MKT' ? 'MKT' : ent.location, amount: String(mktAmt), category: 'marketing', notes: ent.notes });
              if (testAmt > 0) validEntries.push({ therapist: ent.therapist, location: ent.location === 'Testing' ? 'Testing' : ent.location, amount: String(testAmt), category: 'testing', notes: ent.notes });
            });
      if (!validEntries.length) { setRentalMsg({type:"error",text:"Add at least one therapist with an amount"}); return; }
      if (editingRentalWeek) {
        fetch("/api/rental/week/delete", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({week_start: rentalForm.week_start, week_end: rentalForm.week_end})})
          .then(() => fetch("/api/rental", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({week_start: rentalForm.week_start, week_end: rentalForm.week_end, entries: validEntries})}))
          .then(r => r.json()).then(d => {
            if (d.ok) { setRentalMsg({type:"success",text:"Week updated! " + d.count + " entries saved."}); setEditingRentalWeek(null); loadRentalWeek(rentalForm.week_start, rentalForm.week_end); refreshDashboardData(); }
            else setRentalMsg({type:"error",text:d.error || "Save failed"});
          }).catch(() => setRentalMsg({type:"error",text:"Network error"}));
      } else {
        fetch("/api/rental", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({week_start: rentalForm.week_start, week_end: rentalForm.week_end, entries: validEntries})})
          .then(r => r.json()).then(d => {
            if (d.ok) { setRentalMsg({type:"success",text:"Saved! " + d.count + " entries."}); loadRentalWeek(rentalForm.week_start, rentalForm.week_end); refreshDashboardData(); }
            else setRentalMsg({type:"error",text:d.error || "Save failed"});
          }).catch(() => setRentalMsg({type:"error",text:"Network error"}));
      }
    };

    const loadWeekForEdit = (ws, we) => {
      setEditingRentalWeek(ws);
      setRentalForm(f => ({...f, week_start: ws, week_end: we}));
      fetch("/api/rental/week?week_start=" + ws + "&week_end=" + we)
        .then(r => r.json()).then(data => {
          if (Array.isArray(data) && data.length > 0) {
            // Group entries by therapist+location for multi-amount display
                const grouped = {};
                data.forEach(ent => {
                  const key = ent.therapist + '|' + ent.location;
                  if (!grouped[key]) grouped[key] = { therapist: ent.therapist, location: ent.location, amount_room: '', amount_mkt: '', amount_test: '', notes: ent.notes || '' };
                  if (ent.category === 'room_rental') grouped[key].amount_room = String(ent.amount);
                  else if (ent.category === 'marketing') grouped[key].amount_mkt = String(ent.amount);
                  else if (ent.category === 'testing') grouped[key].amount_test = String(ent.amount);
                  if (ent.notes) grouped[key].notes = ent.notes;
                });
                setRentalForm({week_start: ws, week_end: we, entries: Object.values(grouped)}); setRentalMsg({type:"success",text:"Editing week " + ws + " ‚Äî " + we + ". Make changes and click Update."});
          }
        });
    };
        const refreshDashboardData = () => {
          fetch("/api/refresh", {method:"POST"}).then(() => {
            const reFetch = () => fetch("/api/data").then(r => r.json()).then(d => {
              PRECOMPUTED = d;
              setDataVersion(v => v + 1);
            }).catch(() => {});
            setTimeout(reFetch, 6000);
            setTimeout(reFetch, 12000);
          }).catch(() => {});
        };

        const LOCATIONS = ["Fort Lauderdale", "Coral Springs", "Plantation", "Telehealth", "Referred Out"];
        const SERVICE_TYPES = ["Individual Therapy", "Couples Therapy", "Family Therapy", "Adolescent Therapy", "Group Therapy", "Child Therapy", "Supervision", "Psychological Evaluation", "Christian Based Counseling", "Testing Evaluation", "CogScreen", "Psychiatric", "Mental Health Match"];
        const PROBLEMS = ["Relationship Issues", "Stress/Anxiety", "Depression", "Self-Esteem", "Work-Related Issues", "Parenting", "Addiction", "Grief/Loss", "Trauma/PTSD", "Maternal Mental Health", "Testing", "Medication"];
        const REFERRAL_SOURCES = ["Google", "Psychology Today", "Social Media", "Bayview Therapists", "Associations (FAMFT, BAMFT, etc.)", "Doctors", "Psychiatrists", "Colleagues", "Family/Friends", "Previous Clients", "Schools", "BSAC", "FRCF", "ALMA", "BSO", "NeuroHealth Treatment Centers"];
        const ACTIONS = ["Scheduled Appointment", "Referred to Bayview Therapist", "Referred to Outside Provider", "Pending"];
        const THERAPISTS = ["Dr. Heather V", "Dr. Heather K", "Simone F", "Jamie R", "Kimberly G", "Dr. Brittany", "Carla B", "Jackie S", "Kacee T", "BTI Nova", "Insurance", "Medicaid", "Heather D", "Dr. Jeffrey M", "Alexa V", "Alex S", "Sara S", "Tahnee M", "Taylor P", "Jessica C", "Crystal A", "Nicole A", "Pending", "David S", "Tatiana S", "Dr Michael Collins", "Seychelle S", "Caring Therapists", "Lorena A", "Dr. Halle S", "Alyssa W", "Maria C", "Claire C", "Jnay R", "Jorge H", "Jonathan S", "New Nicole G", "Adelle", "Valeria"];
        const OUTCOMES = ["Called", "Emailed", "Left Message", "Booked", "Never Booked", "Cancelled"];

        // fetchPending removed ‚Äî now handled in useEffect

        // fetchRecent removed ‚Äî now handled in useEffect

        const loadLeadForEdit = (lead) => {
            setEditingLeadId(lead.id);
            setIntakeForm({
                date: lead.date || '',
                location: lead.location || '',
                first_name: lead.first_name || '',
                last_name: lead.last_name || '',
                phone: lead.phone || '',
                email: lead.email || '',
                service_type: lead.service_type || '',
                presenting_problem: lead.presenting_problem || '',
                referral_source: lead.referral_source || '',
                action_taken: lead.action_taken || '',
                referred_to: lead.referred_to || '',
                marketing_program: lead.marketing_program || 'No',
                referral_outcome: lead.referral_outcome || '',
                notes: lead.notes || ''
            });
            setIntakeMsg({type:"success", text:"Editing lead #" + lead.id + " ‚Äî " + lead.first_name + " " + lead.last_name + ". Make changes and click Update Lead."});
            window.scrollTo({top: 0, behavior: 'smooth'});
        };
        const submitLead = () => {
            const required = ["date","location","first_name","last_name","phone","service_type","presenting_problem","referral_source","action_taken","referred_to","referral_outcome"];
            const missing = required.filter(f => !intakeForm[f]);
            if (missing.length) { setIntakeMsg({type:"error",text:"Missing: " + missing.join(", ")}); return; }
            if (editingLeadId) {
                fetch("/api/leads/" + editingLeadId, {method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(intakeForm)})
                .then(r => r.json()).then(d => {
                    if (d.ok) {
                        setIntakeMsg({type:"success",text:"Lead #" + editingLeadId + " updated!"});
                        setEditingLeadId(null);
                        setIntakeForm({date: new Date().toISOString().split('T')[0], location:'', first_name:'', last_name:'', phone:'', email:'', service_type:'', presenting_problem:'', referral_source:'', action_taken:'', referred_to:'', marketing_program:'No', referral_outcome:'', notes:''});
                        setLeadRefreshKey(k => k + 1);
                        refreshDashboardData();
                    } else { setIntakeMsg({type:"error",text:d.error || "Update failed"}); }
                }).catch(() => setIntakeMsg({type:"error",text:"Network error"}));
            } else {
                fetch("/api/leads", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(intakeForm)})
                .then(r => r.json()).then(d => {
                    if (d.ok) {
                        setIntakeMsg({type:"success",text:"Lead #" + d.id + " saved!"});
                        setIntakeForm({date: new Date().toISOString().split('T')[0], location:'', first_name:'', last_name:'', phone:'', email:'', service_type:'', presenting_problem:'', referral_source:'', action_taken:'', referred_to:'', marketing_program:'No', referral_outcome:'', notes:''});
                        setLeadRefreshKey(k => k + 1);
                        refreshDashboardData();
                    } else { setIntakeMsg({type:"error",text:d.error || "Save failed"}); }
                }).catch(() => setIntakeMsg({type:"error",text:"Network error"}));
            }
        };

        const updatePendingLead = (id, field, value) => {
          fetch("/api/leads/" + id, {method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify({[field]: value})})
            .then(r => r.json()).then(() => { setLeadRefreshKey(k => k + 1); refreshDashboardData(); });
        };
        const deleteLead = (id, name) => {
          if (!confirm("Delete lead \"" + name + "\"? This cannot be undone.")) return;
          fetch("/api/leads/" + id, {method:"DELETE"})
            .then(r => r.json()).then(d => {
              if (d.ok) { setLeadRefreshKey(k => k + 1); refreshDashboardData(); }
            });
        };

  const [activeTab, setActiveTab] = useState("overview");

        useEffect(() => {
            if (activeTab === "intake") {
                setLoadingPending(true);
                setLoadingRecent(true);
                fetch("/api/leads/pending?days=14").then(r => r.json()).then(data => {
                    setPendingLeads(Array.isArray(data) ? data : []);
                    setLoadingPending(false);
                }).catch(() => setLoadingPending(false));
                fetch("/api/leads/recent?days=30").then(r => r.json()).then(data => {
                    setRecentLeads(Array.isArray(data) ? data : []);
                    setLoadingRecent(false);
                }).catch(() => setLoadingRecent(false));
            }
        }, [activeTab, leadRefreshKey]);

  const tabs = [
    { id: "overview", label: "Overview" },
    { id: "rental", label: "üè† Room Rental" },
    { id: "team", label: "Team" },
          { id: "intake", label: "Lead Intake" },
          { id: "rentalInput", label: "Room Rental Input" },
    { id: "sessions", label: "Sessions" },
  ];
  const filterBtns = [
    { id: "ytd", label: "Year-to-Date" },
    { id: "month", label: "This Month" },
    { id: "week", label: "This Week" },
    { id: "today", label: "Today" },
    { id: "all", label: "All Time" },
    { id: "lastyear", label: "Last Year" },
  ];

  const stats = PRECOMPUTED[timeFilter] || PRECOMPUTED.all;

  // Use monthly for long-range charts (>3 months), daily for short-range
  const useMonthly = stats.monthly.length > 3;
  const chartData = useMonthly
    ? stats.monthly.map(m => ({ date: fmtMonth(m.month), leads: m.leads, booked: m.booked, fullDate: m.month }))
    : stats.daily.map(d => ({ date: fmtDate(d.date), leads: d.leads, booked: d.booked, fullDate: d.date }));

  // Cumulative for forecast
  const prev = stats.prev || null;
  const prevLabels = { ytd: "vs last YTD", lastyear: "vs prior year", month: "vs last month", week: "vs prior week", today: "vs yesterday", all: "" };
  const prevLabel = prevLabels[timeFilter] || "";

  const cumulative = useMemo(() => {
    const src = useMonthly ? stats.monthly : stats.daily;
    let cL = 0, cB = 0;
    return src.map(d => {
      cL += d.leads; cB += d.booked;
      return { date: useMonthly ? fmtMonth(d.month) : fmtDate(d.date), cLeads: cL, cBooked: cB };
    });
  }, [stats, useMonthly]);

        // Enrich team with financials - using actual rental revenue
        // Name alias map for known mismatches between rental and team data
        const NAME_ALIASES = {
          'tahnnee m': 'tahnee m',
          'tatiana st': 'tatiana s',
          'dr jeffrey': 'dr jeffrey m',
          'heather v': 'dr heather v',
          'dr halle r': 'dr halle s',
          'jen p': 'jen r',
          'brittany m': 'dr brittany'
        };
        const MKT_ALIASES = {
          'dr jeff': 'dr jeffrey m',
          'heather kuhl': 'dr heather k',
          'sheilah ladesma': 'sheilah l',
          'jonathan stiglich': 'jonathan s',
          'cadace': 'candace n',
          'lia': 'lia d'
        };
        const norm = (n) => n.replace(/\./g, "").replace(/\s+/g, " ").trim().toLowerCase();
        const stripDr = (n) => n.replace(/^dr\s+/, "");

        // Build a map helper function
        const buildTherapistMap = (listKey, periodMap, aliases) => {
          const R = PRECOMPUTED._rental || {};
          const therapistList = R[listKey] || [];
          const map = {};
          therapistList.forEach(t => {
            if (t.name.toLowerCase().startsWith('testing')) return;
            const key = norm(t.name);
            const resolved = aliases[key] || key;
            map[resolved] = (map[resolved] || 0) + t.total;
            const noDr = stripDr(resolved);
            if (noDr !== resolved) map[noDr] = (map[noDr] || 0) + t.total;
          });
          return map;
        };

        const rentalPeriodMap = { ytd: "ytdTherapists", month: "thisMonthTherapists", week: "thisMonthTherapists", today: "thisMonthTherapists", all: "therapists", lastyear: "lyTherapists" };
        const mktPeriodMap = { ytd: "mktYtdTherapists", month: "mktThisMonthTherapists", week: "mktThisMonthTherapists", today: "mktThisMonthTherapists", all: "mktTherapists", lastyear: "mktLyTherapists" };
        const testPeriodMap = { ytd: "testYtdTherapists", month: "testThisMonthTherapists", week: "testThisMonthTherapists", today: "testThisMonthTherapists", all: "testTherapists", lastyear: "testLyTherapists" };

        const rentalTherapistMap = useMemo(() => buildTherapistMap(rentalPeriodMap[timeFilter] || "therapists", rentalPeriodMap, NAME_ALIASES), [timeFilter]);
        const mktTherapistMap = useMemo(() => buildTherapistMap(mktPeriodMap[timeFilter] || "mktTherapists", mktPeriodMap, {...NAME_ALIASES, ...MKT_ALIASES}), [timeFilter]);
        const testTherapistMap = useMemo(() => buildTherapistMap(testPeriodMap[timeFilter] || "testTherapists", testPeriodMap, NAME_ALIASES), [timeFilter]);

        // Match a team member name against a revenue map
        const matchRevenue = (teamName, revenueMap) => {
          const key = norm(teamName);
          let rev = revenueMap[key] || 0;
          if (!rev) rev = revenueMap[stripDr(key)] || 0;
          if (!rev) {
            // First-name only match (for MKT short names like "Carla", "Jackie")
            const parts = key.replace(/^dr\s+/, '').split(' ');
            const firstName = parts[0];
            // Find all keys that start with this first name
            const matches = Object.keys(revenueMap).filter(k => {
              const kFirst = k.replace(/^dr\s+/, '').split(' ')[0];
              return kFirst === firstName;
            });
            if (matches.length === 1) rev = revenueMap[matches[0]];
            else if (matches.length > 1 && parts.length >= 2) {
              // Try first name + first char of last
              const lastChar = parts[parts.length - 1][0];
              const exactMatch = matches.find(k => {
                const kParts = k.replace(/^dr\s+/, '').split(' ');
                return kParts.length >= 2 && kParts[kParts.length - 1][0] === lastChar;
              });
              if (exactMatch) rev = revenueMap[exactMatch];
            }
          }
          return rev;
        };

        const teamWithFinancials = useMemo(() => {
          return stats.team.map(t => {
            const bayviewRevenue = matchRevenue(t.name, rentalTherapistMap);
            const mktRevenue = matchRevenue(t.name, mktTherapistMap);
            const testRevenue = matchRevenue(t.name, testTherapistMap);
            const totalRevenue = bayviewRevenue + mktRevenue + testRevenue;
            const acqCost = t.leads * COST_PER_LEAD;
            return { ...t, acqCost, bayviewRevenue, mktRevenue, testRevenue, totalRevenue, profit: totalRevenue - acqCost, roi: acqCost > 0 ? Math.round(((totalRevenue - acqCost) / acqCost) * 100) : 0 };
          });
        }, [stats.team, rentalTherapistMap, mktTherapistMap, testTherapistMap]);

        const totalAcq = teamWithFinancials.reduce((s, t) => s + t.acqCost, 0);

  // Date range labels
  const dateLabels = {
    all: "All Data ¬∑ May 1, 2017 ‚Äì February 6, 2026",
    ytd: "Year-to-Date ¬∑ Jan 1, 2026 ‚Äì February 6, 2026",
    lastyear: "Last Year ¬∑ Jan 1, 2025 ‚Äì Dec 31, 2025",
    month: "This Month ¬∑ February 1 ‚Äì February 6, 2026",
    week: "This Week ¬∑ Jan 30 ‚Äì February 6, 2026",
    today: "Today ¬∑ February 6, 2026",
  };

  
  // Sessions data fetching
  useEffect(() => {
    if (activeTab !== "sessions") return;
    setSessionsLoading(true);
    fetch("/api/sessions?weeks=12")
      .then(r => r.json())
      .then(data => {
        setSessionsData(data);
        if (data.weeks && data.weeks.length > 0) {
          const currentIdx = data.weeks.findIndex(w => w.is_current);
          setSessionsWeekIdx(currentIdx >= 0 ? currentIdx : data.weeks.length - 1);
        }
        setSessionsLoading(false);
      })
      .catch(e => { console.error("Sessions fetch error:", e); setSessionsLoading(false); });
  }, [activeTab]);

return (
    <div style={{ fontFamily: "'DM Sans', system-ui, -apple-system, sans-serif", background: C.bg, color: C.text, minHeight: "100vh", fontSize: 13 }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: ${C.bg}; } ::-webkit-scrollbar-thumb { background: ${C.border}; border-radius: 3px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease forwards; }
      `}</style>

      {/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */}
      <div style={{ borderBottom: `1px solid ${C.border}`, padding: "18px 28px", display: "flex", justifyContent: "space-between", alignItems: "center", background: `linear-gradient(180deg, ${C.card} 0%, ${C.bg} 100%)`, flexWrap: "wrap", gap: 12 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 14 }}>
          <div style={{ width: 38, height: 38, borderRadius: 10, background: `linear-gradient(135deg, ${C.accent}, ${C.blue})`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, fontWeight: 700, color: C.bg }}>B</div>
          <div>
            <h1 style={{ fontSize: 18, fontWeight: 700, margin: 0, letterSpacing: -0.5 }}>Bayview Lead Intelligence</h1>
            <p style={{ fontSize: 11, color: C.textMuted, margin: 0 }}>Real-time intake analytics across all locations</p>
          </div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 6, flexWrap: "wrap" }}>
          {filterBtns.map(f => (
            <button key={f.id} onClick={() => setTimeFilter(f.id)} style={{
              padding: "6px 14px", borderRadius: 8,
              border: `1px solid ${timeFilter === f.id ? C.accent + "50" : C.border}`,
              background: timeFilter === f.id ? C.accentGlow : "transparent",
              color: timeFilter === f.id ? C.accent : C.textMuted,
              fontSize: 12, fontWeight: 600, cursor: "pointer", transition: "all 0.2s",
            }}>{f.label}</button>
          ))}
        </div>
      </div>

      {/* ‚îÄ‚îÄ‚îÄ DATE RANGE BANNER ‚îÄ‚îÄ‚îÄ */}
      <div style={{ padding: "8px 28px", background: C.accentGlow, borderBottom: `1px solid ${C.accent}20`, display: "flex", alignItems: "center", gap: 8 }}>
        <span style={{ fontSize: 11, color: C.accent, fontWeight: 600 }}>üìÖ</span>
        <span style={{ fontSize: 12, color: C.accent, fontWeight: 600, letterSpacing: 0.2 }}>{dateLabels[timeFilter]}</span>
        <span style={{ fontSize: 11, color: C.textMuted, marginLeft: "auto" }}>{stats.total.toLocaleString()} leads in this period</span>
      </div>

      {/* ‚îÄ‚îÄ‚îÄ NAV TABS ‚îÄ‚îÄ‚îÄ */}
      <div style={{ padding: "0 28px", borderBottom: `1px solid ${C.border}`, display: "flex", gap: 0 }}>
        {tabs.map(t => (
          <button key={t.id} onClick={() => setActiveTab(t.id)} style={{
            padding: "12px 20px", border: "none",
            borderBottom: `2px solid ${activeTab === t.id ? C.accent : "transparent"}`,
            background: "transparent", color: activeTab === t.id ? C.text : C.textMuted,
            fontSize: 13, fontWeight: 600, cursor: "pointer", transition: "all 0.2s",
          }}>{t.label}</button>
        ))}
      </div>

      {/* ‚îÄ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ‚îÄ */}
      <div style={{ padding: "24px 28px", maxWidth: 1440, margin: "0 auto" }} className="animate-in" key={timeFilter + activeTab}>

          {/* ‚ïê‚ïê‚ïê OVERVIEW TAB ‚ïê‚ïê‚ïê */}
          {activeTab === "overview" && (
            <>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(5, 1fr)", gap: 16, marginBottom: 24 }}>
              <StatCard label="Total Leads" value={stats.total} icon="üìä" color={C.blue} sub={`${stats.daily.length} active days`} prev={prev?.total} prevLabel={prevLabel} />
              <StatCard label="Booked" value={stats.booked} icon="‚úì" color={C.accent} sub={`${stats.bookingRate}% conversion`} prev={prev?.booked} prevLabel={prevLabel} />
              <StatCard label="Top Location" value={stats.topLocation.name} icon="üìç" color={C.warm} sub={`${stats.topLocation.count.toLocaleString()} leads`} />
              <StatCard label="Top Referral" value={stats.topSource.name} icon="üîó" color={C.purple} sub={`${stats.topSource.count.toLocaleString()} leads`} />
              <StatCard label="Top Service" value={stats.topService.name.replace(" Therapy", "")} icon="ü©∫" color={C.rose} sub={`${stats.topService.count.toLocaleString()} requests`} />
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr", gap: 16, marginBottom: 16 }}>
              <ChartCard title={useMonthly ? "Monthly Lead Volume" : "Daily Lead Volume"} subtitle="Leads with booking overlay">
                <ResponsiveContainer width="100%" height={300}>
                  <AreaChart data={chartData}>
                    <defs>
                      <linearGradient id="gLeads" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={C.accent} stopOpacity={0.3} /><stop offset="100%" stopColor={C.accent} stopOpacity={0.02} /></linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
                    <XAxis dataKey="date" tick={{ fontSize: 9, fill: C.textMuted }} axisLine={false} tickLine={false} interval={useMonthly ? "preserveStartEnd" : Math.floor(chartData.length / 8)} />
                    <YAxis tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} />
                    <Tooltip content={<Tip />} />
                    <Area type="monotone" dataKey="leads" name="Leads" stroke={C.accent} fill="url(#gLeads)" strokeWidth={2} />
                    <Line type="monotone" dataKey="booked" name="Booked" stroke={C.warm} strokeWidth={2} strokeDasharray="4 4" dot={false} />
                  </AreaChart>
                </ResponsiveContainer>
              </ChartCard>

              <ChartCard title="Leads vs Booked by Location" subtitle="Conversion by office">
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={stats.locations} margin={{ left: 10, right: 20 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
                    <XAxis dataKey="name" tick={{ fontSize: 9, fill: C.textMuted }} axisLine={false} tickLine={false} />
                    <YAxis tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} />
                    <Tooltip content={<Tip />} />
                    <Legend wrapperStyle={{ fontSize: 11 }} />
                    <Bar dataKey="leads" name="Leads" fill={C.blue} radius={[4, 4, 0, 0]} barSize={24} />
                    <Bar dataKey="booked" name="Booked" fill={C.accent} radius={[4, 4, 0, 0]} barSize={24} />
                  </BarChart>
                </ResponsiveContainer>
              </ChartCard>
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 16 }}>
              <ChartCard title="Cumulative Leads vs Booked" subtitle="Running totals ‚Äî gap = unconverted pipeline">
                <ResponsiveContainer width="100%" height={300}>
                  <AreaChart data={cumulative}>
                    <defs>
                      <linearGradient id="gcL" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={C.blue} stopOpacity={0.3} /><stop offset="100%" stopColor={C.blue} stopOpacity={0.02} /></linearGradient>
                      <linearGradient id="gcB" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={C.accent} stopOpacity={0.3} /><stop offset="100%" stopColor={C.accent} stopOpacity={0.02} /></linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
                    <XAxis dataKey="date" tick={{ fontSize: 9, fill: C.textMuted }} axisLine={false} tickLine={false} interval="preserveStartEnd" />
                    <YAxis tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} />
                    <Tooltip content={<Tip />} />
                    <Area type="monotone" dataKey="cLeads" name="Cumulative Leads" stroke={C.blue} fill="url(#gcL)" strokeWidth={2} />
                    <Area type="monotone" dataKey="cBooked" name="Cumulative Booked" stroke={C.accent} fill="url(#gcB)" strokeWidth={2} />
                  </AreaChart>
                </ResponsiveContainer>
              </ChartCard>

              <ChartCard title="Action Taken" subtitle="How leads are being processed">
                <ResponsiveContainer width="100%" height={280}>
                  <PieChart>
                    <Pie data={stats.actions} dataKey="count" nameKey="name" cx="50%" cy="50%" innerRadius={50} outerRadius={90} paddingAngle={2} label={({ name, count }) => `${name} (${count.toLocaleString()})`} labelLine={{ stroke: C.textDim }} style={{ fontSize: 9 }}>
                      {stats.actions.map((_, i) => <Cell key={i} fill={CHART_COLORS[i % CHART_COLORS.length]} />)}
                    </Pie>
                    <Tooltip content={<Tip />} />
                  </PieChart>
                </ResponsiveContainer>
              </ChartCard>
            </div>

            <ChartCard title="Conversion Rate by Location" subtitle="Booking percentage per office">
              <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(220px, 1fr))", gap: 12, marginTop: 8 }}>
                {stats.locations.map(loc => {
                  const rate = loc.leads > 0 ? Math.round(loc.booked / loc.leads * 100) : 0;
                  return (
                    <div key={loc.name} style={{ background: C.bg, border: `1px solid ${C.border}`, borderRadius: 10, padding: "14px 16px" }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                        <span style={{ fontSize: 13, fontWeight: 600, color: C.text }}>{loc.name}</span>
                        <span style={{ fontSize: 16, fontWeight: 700, color: rate >= 35 ? C.accent : rate >= 20 ? C.warm : C.rose }}>{rate}%</span>
                      </div>
                      <div style={{ fontSize: 11, color: C.textMuted, marginBottom: 6 }}>{loc.leads.toLocaleString()} leads ‚Üí {loc.booked.toLocaleString()} booked</div>
                      <div style={{ height: 4, background: C.border, borderRadius: 2, overflow: "hidden" }}>
                        <div style={{ height: "100%", width: `${rate}%`, background: rate >= 35 ? C.accent : rate >= 20 ? C.warm : C.rose, borderRadius: 2 }} />
                      </div>
                    </div>
                  );
                })}
              </div>
            </ChartCard>

            {/* Yearly trend */}
            {stats.yearly.length > 1 && (
              <ChartCard title="üìà Year-over-Year Growth" subtitle="Annual lead volume and bookings" style={{ marginBottom: 16 }}>
                <ResponsiveContainer width="100%" height={280}>
                  <BarChart data={stats.yearly}>
                    <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
                    <XAxis dataKey="year" tick={{ fontSize: 11, fill: C.textMuted }} axisLine={false} tickLine={false} />
                    <YAxis tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} />
                    <Tooltip content={<Tip />} />
                    <Legend wrapperStyle={{ fontSize: 11 }} />
                    <Bar dataKey="leads" name="Leads" fill={C.blue} radius={[4, 4, 0, 0]} barSize={30} />
                    <Bar dataKey="booked" name="Booked" fill={C.accent} radius={[4, 4, 0, 0]} barSize={30} />
                  </BarChart>
                </ResponsiveContainer>
              </ChartCard>
            )}

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
              <ChartCard title="Services Requested" subtitle="Types of therapy being sought">
                <ResponsiveContainer width="100%" height={Math.max(250, stats.services.length * 30)}>
                  <BarChart data={stats.services} layout="vertical" margin={{ left: 10 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke={C.border} horizontal={false} />
                    <XAxis type="number" tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} />
                    <YAxis dataKey="name" type="category" tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} width={130} />
                    <Tooltip content={<Tip />} />
                    <Bar dataKey="count" name="Requests" radius={[0, 6, 6, 0]} barSize={16}>
                      {stats.services.map((_, i) => <Cell key={i} fill={CHART_COLORS[i % CHART_COLORS.length]} />)}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              </ChartCard>

              <ChartCard title="Presenting Problems" subtitle="What clients need help with">
                <ResponsiveContainer width="100%" height={Math.max(250, stats.problems.length * 30)}>
                  <BarChart data={stats.problems} layout="vertical" margin={{ left: 10 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke={C.border} horizontal={false} />
                    <XAxis type="number" tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} />
                    <YAxis dataKey="name" type="category" tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} width={130} />
                    <Tooltip content={<Tip />} />
                    <Bar dataKey="count" name="Cases" radius={[0, 6, 6, 0]} barSize={16}>
                      {stats.problems.map((_, i) => <Cell key={i} fill={CHART_COLORS[(i + 3) % CHART_COLORS.length]} />)}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              </ChartCard>
            </div>
            </>
          )}



          {/* ‚ïê‚ïê‚ïê TEAM TAB ‚ïê‚ïê‚ïê */}
          {activeTab === "team" && (() => {
            const allTimeStats = PRECOMPUTED.all || {};
            const weekStats = PRECOMPUTED.week || {};
            const allTeam = allTimeStats.team || [];
            const weekTeam = weekStats.team || [];
            const weekMap = {};
            weekTeam.forEach(t => { weekMap[t.name] = t; });

            // Marketing analysis
            const mktMembers = stats.team.filter(t => t.mkt);
            const nonMktMembers = stats.team.filter(t => !t.mkt);
            const mktAvgRate = mktMembers.length > 0 ? Math.round(mktMembers.reduce((s, t) => s + t.rate, 0) / mktMembers.length) : 0;
            const nonMktAvgRate = nonMktMembers.length > 0 ? Math.round(nonMktMembers.reduce((s, t) => s + t.rate, 0) / nonMktMembers.length) : 0;
            const mktTotalLeads = mktMembers.reduce((s, t) => s + t.leads, 0);
            const nonMktTotalLeads = nonMktMembers.reduce((s, t) => s + t.leads, 0);

            // Rising stars: therapists whose week rate > all-time rate AND have recent activity
            const risers = stats.team.filter(t => t.leads >= 1).map(t => {
              const allTime = allTeam.find(a => a.name === t.name);
              const wk = weekMap[t.name];
              return {
                ...t,
                allRate: allTime?.rate || 0,
                allLeads: allTime?.leads || 0,
                weekLeads: wk?.leads || 0,
                weekBooked: wk?.booked || 0,
                weekRate: wk?.rate || 0,
                rateChange: (wk?.rate || 0) - (allTime?.rate || 0),
                isNew: (allTime?.leads || 0) < 30,
              };
            });

            // Conversion concerns: high leads but low rate
            const concerns = stats.team.filter(t => t.leads >= 3 && t.rate < 40).sort((a, b) => b.leads - a.leads);

            // Up-and-comers: rising rate this week vs all-time
            const upAndComers = risers.filter(t => t.weekLeads >= 1 && t.rateChange > 0).sort((a, b) => b.rateChange - a.rateChange);

            // Non-mkt benefiting most (getting leads without paying for marketing)
            const nonMktBenefiting = stats.team.filter(t => !t.mkt && t.leads > 0).sort((a, b) => b.leads - a.leads);

            return (
            <>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 16, marginBottom: 24 }}>
              <StatCard label="Top Performer" value={stats.team[0]?.name || "‚Äî"} icon="üèÜ" color="#FFD700" sub={`${stats.team[0]?.leads || 0} leads received`} />
              <StatCard label="Best Conversion" value={(stats.team.filter(t => t.leads >= 5).sort((a, b) => b.rate - a.rate)[0])?.name || "‚Äî"} icon="üéØ" color={C.accent} sub={`${(stats.team.filter(t => t.leads >= 5).sort((a, b) => b.rate - a.rate)[0])?.rate || 0}% booking rate`} />
              <StatCard label="Needs Attention" value={concerns[0]?.name || "‚Äî"} icon="‚ö†Ô∏è" color={C.rose} sub={concerns[0] ? `${concerns[0].leads} leads ¬∑ ${concerns[0].rate}% conversion` : "All good"} />
              <StatCard label="Rising Star" value={upAndComers[0]?.name || "‚Äî"} icon="üöÄ" color={C.warm} sub={upAndComers[0] ? `+${upAndComers[0].rateChange}% vs all-time avg` : "No trending data"} />
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 16 }}>
              <ChartCard title="üèÖ Team Lead Rankings" subtitle="Sorted by leads received ‚Äî top 25">
                <div style={{ maxHeight: 500, overflowY: "auto", paddingRight: 8 }}>
                  {stats.team.slice(0, 25).map((member, i) => (
                    <RankRow key={member.name} rank={i + 1} name={member.name} count={member.leads} booked={member.booked} rate={member.rate} max={stats.team[0]?.leads || 1} color={i === 0 ? "#FFD700" : i === 1 ? "#C0C0C0" : i === 2 ? "#CD7F32" : C.accent} />
                  ))}
                </div>
              </ChartCard>

              <ChartCard title="üìä Leads vs Booked by Therapist" subtitle="Top 15 ‚Äî who converts the most?">
                <ResponsiveContainer width="100%" height={500}>
                  <BarChart data={stats.team.slice(0, 15)} layout="vertical" margin={{ left: 10, right: 20 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke={C.border} horizontal={false} />
                    <XAxis type="number" tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} />
                    <YAxis dataKey="name" type="category" tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} width={100} />
                    <Tooltip content={<Tip />} />
                    <Legend wrapperStyle={{ fontSize: 11, color: C.textMuted }} />
                    <Bar dataKey="leads" name="Total Leads" fill={C.blue} radius={[0, 4, 4, 0]} barSize={12} />
                    <Bar dataKey="booked" name="Booked" fill={C.accent} radius={[0, 4, 4, 0]} barSize={12} />
                  </BarChart>
                </ResponsiveContainer>
              </ChartCard>
            </div>

            {/* Therapist Revenue & Acquisition */}
            <ChartCard title="üí∞ Therapist Revenue & Acquisition" subtitle={`$${COST_PER_LEAD}/lead ¬∑ Bayview Lead Cost ‚Äî room rental + marketing + testing revenue`} style={{ marginBottom: 16 }}>
              <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))", gap: 12, marginTop: 8 }}>
                {teamWithFinancials.slice(0, 20).map((t) => (
                  <div key={t.name} style={{ background: C.bg, border: `1px solid ${C.border}`, borderRadius: 10, padding: "16px 18px", position: "relative", overflow: "hidden" }}>
                    <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 3, background: t.profit >= 0 ? C.accent : C.rose, opacity: 0.6 }} />
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                      <div style={{ fontSize: 14, fontWeight: 700, color: C.text }}>{t.name}{t.mkt && <span title="Marketing Program" style={{ marginLeft: 6, fontSize: 12 }}>üì£</span>}</div>
                      <div style={{ padding: "2px 8px", borderRadius: 6, fontSize: 11, fontWeight: 700, background: t.rate >= 70 ? `${C.accent}20` : t.rate >= 50 ? `${C.warm}20` : `${C.rose}20`, color: t.rate >= 70 ? C.accent : t.rate >= 50 ? C.warm : C.rose }}>{t.rate}% booked</div>
                    </div>
                    <div style={{ display: "flex", gap: 16, marginBottom: 8 }}>
                      <div><div style={{ fontSize: 10, color: C.textDim, textTransform: "uppercase", letterSpacing: 0.5 }}>Leads</div><div style={{ fontSize: 16, fontWeight: 700, color: C.text }}>{t.leads.toLocaleString()}</div></div>
                      <div><div style={{ fontSize: 10, color: C.textDim, textTransform: "uppercase", letterSpacing: 0.5 }}>Booked</div><div style={{ fontSize: 16, fontWeight: 700, color: C.accent }}>{t.booked.toLocaleString()}</div></div>
                      <div style={{ marginLeft: "auto", textAlign: "right" }}><div style={{ fontSize: 10, color: C.textDim, textTransform: "uppercase", letterSpacing: 0.5 }}>ROI</div><div style={{ fontSize: 16, fontWeight: 700, color: t.roi >= 0 ? C.accent : C.rose }}>{t.roi}%</div></div>
                    </div>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", borderTop: `1px solid ${C.border}`, paddingTop: 8, marginTop: 4 }}>
              <div style={{ fontSize: 11, color: C.rose }}><span style={{ color: C.textMuted }}>Lead Cost: </span>{fmtCurrency(t.acqCost)}</div>
              <div style={{ fontSize: 11, color: C.accent }}><span style={{ color: C.textMuted }}>Room Rev: </span>{fmtCurrency(t.bayviewRevenue)}</div>
              {t.mktRevenue > 0 && <div style={{ fontSize: 11, color: '#A78BFA' }}><span style={{ color: C.textMuted }}>Mkt Rev: </span>{fmtCurrency(t.mktRevenue)}</div>}
              {t.testRevenue > 0 && <div style={{ fontSize: 11, color: '#60A5FA' }}><span style={{ color: C.textMuted }}>Test Rev: </span>{fmtCurrency(t.testRevenue)}</div>}
                      <div style={{ fontSize: 11, fontWeight: 700, color: t.profit >= 0 ? C.accent : C.rose }}>{t.profit >= 0 ? "+" : ""}{fmtCurrency(t.profit)}</div>
                    </div>
                  </div>
                ))}
              </div>
            </ChartCard>

            {/* Marketing Intelligence */}
            <ChartCard title="üì£ Marketing Intelligence" subtitle={`${mktMembers.length} on program ¬∑ ${nonMktMembers.length} not enrolled ‚Äî who\'s benefiting without paying?`} style={{ marginBottom: 16 }}>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginTop: 8 }}>
                {/* Summary Stats */}
                <div style={{ background: C.bg, borderRadius: 10, padding: 16, border: `1px solid ${C.border}` }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: C.accent, marginBottom: 12, textTransform: "uppercase", letterSpacing: 1 }}>üü¢ Marketing Members</div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12, marginBottom: 12 }}>
                    <div><div style={{ fontSize: 10, color: C.textDim }}>MEMBERS</div><div style={{ fontSize: 20, fontWeight: 800, color: C.text }}>{mktMembers.length}</div></div>
                    <div><div style={{ fontSize: 10, color: C.textDim }}>TOTAL LEADS</div><div style={{ fontSize: 20, fontWeight: 800, color: C.blue }}>{mktTotalLeads.toLocaleString()}</div></div>
                    <div><div style={{ fontSize: 10, color: C.textDim }}>AVG RATE</div><div style={{ fontSize: 20, fontWeight: 800, color: C.accent }}>{mktAvgRate}%</div></div>
                  </div>
                  <div style={{ maxHeight: 200, overflowY: "auto" }}>
                    {mktMembers.sort((a,b) => b.leads - a.leads).slice(0, 10).map(t => (
                      <div key={t.name} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "6px 0", borderBottom: `1px solid ${C.border}` }}>
                        <span style={{ fontSize: 12, color: C.text }}>{t.name}</span>
                        <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
                          <span style={{ fontSize: 11, color: C.textMuted }}>{t.leads} leads</span>
                          <span style={{ fontSize: 11, fontWeight: 700, color: t.rate >= 60 ? C.accent : t.rate >= 40 ? C.warm : C.rose }}>{t.rate}%</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div style={{ background: C.bg, borderRadius: 10, padding: 16, border: `1px solid ${C.border}` }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: C.warm, marginBottom: 12, textTransform: "uppercase", letterSpacing: 1 }}>üü† Not on Marketing</div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12, marginBottom: 12 }}>
                    <div><div style={{ fontSize: 10, color: C.textDim }}>MEMBERS</div><div style={{ fontSize: 20, fontWeight: 800, color: C.text }}>{nonMktMembers.length}</div></div>
                    <div><div style={{ fontSize: 10, color: C.textDim }}>TOTAL LEADS</div><div style={{ fontSize: 20, fontWeight: 800, color: C.blue }}>{nonMktTotalLeads.toLocaleString()}</div></div>
                    <div><div style={{ fontSize: 10, color: C.textDim }}>AVG RATE</div><div style={{ fontSize: 20, fontWeight: 800, color: nonMktAvgRate >= mktAvgRate ? C.accent : C.warm }}>{nonMktAvgRate}%</div></div>
                  </div>
                  <div style={{ maxHeight: 200, overflowY: "auto" }}>
                    {nonMktBenefiting.slice(0, 10).map(t => (
                      <div key={t.name} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "6px 0", borderBottom: `1px solid ${C.border}` }}>
                        <span style={{ fontSize: 12, color: C.text }}>{t.name}</span>
                        <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
                          <span style={{ fontSize: 11, color: C.textMuted }}>{t.leads} leads</span>
                          <span style={{ fontSize: 11, fontWeight: 700, color: t.rate >= 60 ? C.accent : t.rate >= 40 ? C.warm : C.rose }}>{t.rate}%</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </ChartCard>

            {/* Rising Stars & Conversion Concerns */}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 16 }}>
              {/* Up & Comers */}
              <ChartCard title="üöÄ Rising Stars" subtitle="Trending above their all-time avg this week">
                <div style={{ maxHeight: 350, overflowY: "auto" }}>
                  {upAndComers.length === 0 && <div style={{ padding: 20, textAlign: "center", color: C.textMuted, fontSize: 12 }}>No trending data for current period</div>}
                  {upAndComers.slice(0, 12).map((t, i) => (
                    <div key={t.name} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 12px", borderBottom: `1px solid ${C.border}`, background: i === 0 ? `${C.accent}08` : "transparent" }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                        <span style={{ fontSize: 16 }}>{i === 0 ? "üåü" : i < 3 ? "‚≠ê" : "üü¢"}</span>
                        <div>
                          <div style={{ fontSize: 13, fontWeight: 700, color: C.text }}>{t.name}{t.mkt && <span style={{ marginLeft: 5, fontSize: 10, color: C.accent }}>üì£</span>}{t.isNew && <span style={{ marginLeft: 5, fontSize: 9, padding: "1px 5px", borderRadius: 4, background: `${C.warm}20`, color: C.warm }}>NEW</span>}</div>
                          <div style={{ fontSize: 10, color: C.textMuted }}>This week: {t.weekLeads} leads ¬∑ {t.weekBooked} booked ¬∑ {t.weekRate}%</div>
                        </div>
                      </div>
                      <div style={{ textAlign: "right" }}>
                        <div style={{ fontSize: 14, fontWeight: 800, color: C.accent }}>+{t.rateChange}%</div>
                        <div style={{ fontSize: 9, color: C.textMuted }}>vs {t.allRate}% avg</div>
                      </div>
                    </div>
                  ))}
                </div>
              </ChartCard>

              {/* Conversion Concerns */}
              <ChartCard title="‚ö†Ô∏è Conversion Concerns" subtitle="High lead volume but low booking rate (<40%)">
                <div style={{ maxHeight: 350, overflowY: "auto" }}>
                  {concerns.length === 0 && <div style={{ padding: 20, textAlign: "center", color: C.textMuted, fontSize: 12 }}>All therapists converting well!</div>}
                  {concerns.slice(0, 12).map((t, i) => {
                    const lostOpp = Math.round(t.leads * 0.5) - t.booked;
                    return (
                    <div key={t.name} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 12px", borderBottom: `1px solid ${C.border}` }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                        <span style={{ fontSize: 14, color: C.rose }}>‚óè</span>
                        <div>
                          <div style={{ fontSize: 13, fontWeight: 700, color: C.text }}>{t.name}{t.mkt && <span style={{ marginLeft: 5, fontSize: 10, color: C.accent }}>üì£</span>}</div>
                          <div style={{ fontSize: 10, color: C.textMuted }}>{t.leads} leads ¬∑ {t.booked} booked</div>
                        </div>
                      </div>
                      <div style={{ textAlign: "right" }}>
                        <div style={{ fontSize: 14, fontWeight: 800, color: C.rose }}>{t.rate}%</div>
                        <div style={{ fontSize: 9, color: C.rose }}>~{lostOpp > 0 ? lostOpp : 0} potential lost</div>
                      </div>
                    </div>
                    );
                  })}
                </div>
              </ChartCard>
            </div>

            {/* Referral Tracking: Insurance & Medicaid */}
            {(stats.referrals && stats.referrals.length > 0) && (
              <ChartCard title="Referred Out ‚Äî Insurance & Medicaid" subtitle="Leads referred to insurance or medicaid providers" style={{ marginBottom: 16 }}>
                <div style={{ maxHeight: 300, overflowY: "auto", paddingRight: 8 }}>
                  {stats.referrals.map((member, i) => (
                    <RankRow key={member.name} rank={i + 1} name={member.name} count={member.leads} booked={member.booked} rate={member.rate} max={stats.referrals[0]?.leads || 1} color="#EAB308" />
                  ))}
                </div>
              </ChartCard>
            )}

            {/* Pending Leads */}
            {(stats.pending && stats.pending.length > 0) && (
              <ChartCard title="Pending" subtitle="Leads still awaiting assignment" style={{ marginBottom: 16 }}>
                <div style={{ maxHeight: 200, overflowY: "auto", paddingRight: 8 }}>
                  {stats.pending.map((member, i) => (
                    <RankRow key={member.name} rank={i + 1} name={member.name} count={member.leads} booked={member.booked} rate={member.rate} max={stats.pending[0]?.leads || 1} color="#6B7280" />
                  ))}
                </div>
              </ChartCard>
            )}
            </>
            );
          })()}




            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEAD INTAKE TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
            {activeTab === "intake" && (
              <div>
                {/* ‚îÄ‚îÄ Intake Form ‚îÄ‚îÄ */}
                <ChartCard title="New Lead Intake" subtitle="Enter new lead information" style={{marginBottom: 24}}>
                  {intakeMsg && <div style={{padding:"10px 16px", marginBottom:12, borderRadius:8, background: intakeMsg.type==="success" ? "#064E3B" : "#7F1D1D", color: intakeMsg.type==="success" ? C.accent : C.rose, fontSize:13}}>{intakeMsg.text}</div>}
                  <div style={{display:"grid", gridTemplateColumns:"repeat(auto-fill, minmax(220px, 1fr))", gap:12}}>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Date *</label><input type="date" value={intakeForm.date} onChange={e => setIntakeForm({...intakeForm, date: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}} /></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Location *</label><select value={intakeForm.location} onChange={e => setIntakeForm({...intakeForm, location: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}}><option value="">Select...</option>{LOCATIONS.map(l => <option key={l} value={l}>{l}</option>)}</select></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>First Name *</label><input value={intakeForm.first_name} onChange={e => setIntakeForm({...intakeForm, first_name: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}} /></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Last Name *</label><input value={intakeForm.last_name} onChange={e => setIntakeForm({...intakeForm, last_name: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}} /></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Phone *</label><input placeholder="xxx-xxx-xxxx" value={intakeForm.phone} onChange={e => setIntakeForm({...intakeForm, phone: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}} /></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Email</label><input value={intakeForm.email} onChange={e => setIntakeForm({...intakeForm, email: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}} /></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Type of Service *</label><select value={intakeForm.service_type} onChange={e => setIntakeForm({...intakeForm, service_type: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}}><option value="">Select...</option>{SERVICE_TYPES.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Presenting Problem *</label><select value={intakeForm.presenting_problem} onChange={e => setIntakeForm({...intakeForm, presenting_problem: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}}><option value="">Select...</option>{PROBLEMS.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Referral Source *</label><select value={intakeForm.referral_source} onChange={e => setIntakeForm({...intakeForm, referral_source: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}}><option value="">Select...</option>{REFERRAL_SOURCES.map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Action Taken *</label><select value={intakeForm.action_taken} onChange={e => setIntakeForm({...intakeForm, action_taken: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}}><option value="">Select...</option>{ACTIONS.map(a => <option key={a} value={a}>{a}</option>)}</select></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Referred to Bayview Team? *</label><select value={intakeForm.referred_to} onChange={e => setIntakeForm({...intakeForm, referred_to: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}}><option value="">Select...</option>{THERAPISTS.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Marketing Program? *</label><select value={intakeForm.marketing_program} onChange={e => setIntakeForm({...intakeForm, marketing_program: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}}><option value="Yes">Yes</option><option value="No">No</option></select></div>
                    <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Referral Outcome *</label><select value={intakeForm.referral_outcome} onChange={e => setIntakeForm({...intakeForm, referral_outcome: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}}><option value="">Select...</option>{OUTCOMES.map(o => <option key={o} value={o}>{o}</option>)}</select></div>
                  </div>
                  <div style={{marginTop:12}}><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Notes</label><textarea value={intakeForm.notes} onChange={e => setIntakeForm({...intakeForm, notes: e.target.value})} rows={2} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13, resize:"vertical"}} /></div>
                  <div style={{display:"flex", gap:12, marginTop:16}}>
                    <button onClick={submitLead} style={{padding:"10px 32px", background: editingLeadId ? "#F59E0B" : C.accent, color:"#0B0E11", border:"none", borderRadius:8, fontWeight:700, fontSize:14, cursor:"pointer"}}>{editingLeadId ? "Update Lead #" + editingLeadId : "Submit Lead"}</button>
                    {editingLeadId && <button onClick={() => { setEditingLeadId(null); setIntakeForm({date: new Date().toISOString().split('T')[0], location:'', first_name:'', last_name:'', phone:'', email:'', service_type:'', presenting_problem:'', referral_source:'', action_taken:'', referred_to:'', marketing_program:'No', referral_outcome:'', notes:''}); setIntakeMsg(null); }} style={{padding:"10px 24px", background:"transparent", color:C.textMuted, border:"1px solid #2a2a4a", borderRadius:8, fontWeight:600, fontSize:14, cursor:"pointer"}}>Cancel Edit</button>}
                    </div>
                </ChartCard>

                {/* ‚îÄ‚îÄ Pending Leads Manager ‚îÄ‚îÄ */}
                <ChartCard title="Pending Leads" subtitle={"Leads awaiting therapist assignment or booking confirmation (last 14 days) \u00B7 " + pendingLeads.length + " pending"}>
                  {loadingPending ? <div style={{color:C.textMuted, padding:20, textAlign:"center"}}>Loading...</div> :
                  pendingLeads.length === 0 ? <div style={{color:C.textMuted, padding:20, textAlign:"center"}}>No pending leads in the last 14 days</div> :
                  <div style={{overflowX:"auto"}}>
                    <table style={{width:"100%", borderCollapse:"collapse", fontSize:12}}>
                      <thead><tr style={{borderBottom:"1px solid #2a2a4a"}}>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Date</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Name</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Phone</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Service</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Location</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Days</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Assigned To</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Outcome</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Notes</th>
                        <th style={{padding:"8px 6px", textAlign:"center", color:C.textMuted, fontWeight:600, width:"40px"}}></th>
                      </tr></thead>
                      <tbody>{pendingLeads.map(lead => {
                        const daysAgo = Math.floor((Date.now() - new Date(lead.date).getTime()) / 86400000);
                        return <tr key={lead.id} onClick={() => loadLeadForEdit(lead)} style={{borderBottom:"1px solid #1a1a2e", cursor:"pointer"}} onMouseEnter={e => e.currentTarget.style.background="#141428"} onMouseLeave={e => e.currentTarget.style.background="transparent"}>
                          <td style={{padding:"8px 6px", color:C.text, whiteSpace:"nowrap"}}>{lead.date}</td>
                          <td style={{padding:"8px 6px", color:C.text, fontWeight:600}}>{lead.first_name} {lead.last_name}</td>
                          <td style={{padding:"8px 6px", color:C.textMuted, whiteSpace:"nowrap"}}>{lead.phone}</td>
                          <td style={{padding:"8px 6px", color:C.textMuted, maxWidth:120, overflow:"hidden", textOverflow:"ellipsis"}}>{lead.service_type}</td>
                          <td style={{padding:"8px 6px", color:C.textMuted}}>{lead.location}</td>
                          <td style={{padding:"8px 6px", color: daysAgo >= 10 ? C.rose : daysAgo >= 5 ? C.yellow : C.accent, fontWeight:700}}>{daysAgo}d</td>
                          <td style={{padding:"8px 6px"}}><select value={lead.referred_to} onChange={e => updatePendingLead(lead.id, "referred_to", e.target.value)} style={{padding:"4px 6px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:4, color: C.text, fontSize:11, maxWidth:130}}><option value="Pending">Pending</option>{THERAPISTS.filter(t => t !== "Pending").map(t => <option key={t} value={t}>{t}</option>)}</select></td>
                          <td style={{padding:"8px 6px"}}><select value={lead.referral_outcome} onChange={e => updatePendingLead(lead.id, "referral_outcome", e.target.value)} style={{padding:"4px 6px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:4, color: lead.referral_outcome === "Booked" ? C.accent : lead.referral_outcome === "Never Booked" ? C.rose : C.text, fontSize:11}}>{OUTCOMES.map(o => <option key={o} value={o}>{o}</option>)}</select></td>
                          <td style={{padding:"8px 6px", color:C.textMuted, fontSize:11, maxWidth:150, overflow:"hidden", textOverflow:"ellipsis"}}>{lead.notes}</td>
                          <td style={{padding:"8px 6px", textAlign:"center"}}><button onClick={() => deleteLead(lead.id, lead.first_name + " " + lead.last_name)} style={{background:"transparent", border:"none", color:C.rose, cursor:"pointer", fontSize:"16px", padding:"2px 6px"}} title="Delete lead">√ó</button></td>
                        </tr>;
                      })}</tbody>
                    </table>
                  </div>}
                </ChartCard>

                {/* ‚îÄ‚îÄ Recent Leads (Last 30 Days) ‚îÄ‚îÄ */}
                <ChartCard title="Recent Leads" subtitle={"All leads from the last 30 days \u00B7 " + recentLeads.length + " leads"} style={{marginTop: 24}}>
                  {loadingRecent ? <div style={{color:C.textMuted, padding:20, textAlign:"center"}}>Loading...</div> :
                  recentLeads.length === 0 ? <div style={{color:C.textMuted, padding:20, textAlign:"center"}}>No leads in the last 30 days</div> :
                  <div style={{overflowX:"auto", maxHeight: 500, overflowY:"auto"}}>
                    <table style={{width:"100%", borderCollapse:"collapse", fontSize:12}}>
                      <thead style={{position:"sticky", top:0, background:C.card, zIndex:1}}><tr style={{borderBottom:"1px solid #2a2a4a"}}>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>#</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Date</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Name</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Phone</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Location</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Service</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Referred To</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Outcome</th>
                        <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Source</th>
                        <th style={{padding:"8px 6px", textAlign:"center", color:C.textMuted, fontWeight:600, width:"40px"}}></th>
                      </tr></thead>
                      <tbody>{recentLeads.map(lead => (
                        <tr key={lead.id} onClick={() => loadLeadForEdit(lead)} style={{borderBottom:"1px solid #1a1a2e", cursor:"pointer", background: editingLeadId === lead.id ? "#1E3A5F" : "transparent", transition:"background 0.15s"}} onMouseEnter={e => { if (editingLeadId !== lead.id) e.currentTarget.style.background="#141428"; }} onMouseLeave={e => { if (editingLeadId !== lead.id) e.currentTarget.style.background="transparent"; }}>
                          <td style={{padding:"8px 6px", color:C.textMuted, fontSize:11}}>{lead.id}</td>
                          <td style={{padding:"8px 6px", color:C.text, whiteSpace:"nowrap"}}>{lead.date}</td>
                          <td style={{padding:"8px 6px", color:C.text, fontWeight:600, whiteSpace:"nowrap"}}>{lead.first_name} {lead.last_name}</td>
                          <td style={{padding:"8px 6px", color:C.textMuted, whiteSpace:"nowrap"}}>{lead.phone}</td>
                          <td style={{padding:"8px 6px", color:C.textMuted}}>{lead.location}</td>
                          <td style={{padding:"8px 6px", color:C.textMuted, maxWidth:120, overflow:"hidden", textOverflow:"ellipsis"}}>{lead.service_type}</td>
                          <td style={{padding:"8px 6px", color: C.text, fontWeight:600}}>{lead.referred_to}</td>
                          <td style={{padding:"8px 6px", color: lead.referral_outcome === "Booked" ? C.accent : lead.referral_outcome === "Never Booked" || lead.referral_outcome === "Cancelled" ? C.rose : C.textMuted}}>{lead.referral_outcome}</td>
                          <td style={{padding:"8px 6px", color:C.textMuted, fontSize:11}}>{lead.referral_source}</td>
                          <td style={{padding:"8px 6px", textAlign:"center"}}><button onClick={(e) => { e.stopPropagation(); deleteLead(lead.id, lead.first_name + " " + lead.last_name); }} style={{background:"transparent", border:"none", color:C.rose, cursor:"pointer", fontSize:"16px", padding:"2px 6px"}} title="Delete lead">√ó</button></td>
                        </tr>
                      ))}</tbody>
                    </table>
                  </div>}
                </ChartCard>
              </div>
            )}




        {/* ‚ïê‚ïê‚ïê SESSIONS TAB ‚ïê‚ïê‚ïê */}
        
          {/* ‚ïê‚ïê‚ïê ROOM RENTAL INPUT TAB ‚ïê‚ïê‚ïê */}
          {activeTab === "rentalInput" && (
            <div>
              <ChartCard title="Weekly Room Rental Input" subtitle="Enter weekly rental amounts per therapist ‚Äî supports room rental, marketing & testing amounts per entry">
                {rentalMsg && <div style={{padding:"10px 16px", marginBottom:12, borderRadius:8, background: rentalMsg.type==="success" ? "#064E3B" : "#7F1D1D", color: rentalMsg.type==="success" ? C.accent : C.rose, fontSize:13}}>{rentalMsg.text}</div>}
                <div style={{display:"grid", gridTemplateColumns:"1fr 1fr", gap:12, marginBottom:16}}>
                  <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Week Start (Monday) *</label><input type="date" value={rentalForm.week_start} onChange={e => setRentalForm({...rentalForm, week_start: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}} /></div>
                  <div><label style={{fontSize:11, color:C.textMuted, display:"block", marginBottom:4}}>Week End (Sunday) *</label><input type="date" value={rentalForm.week_end} onChange={e => setRentalForm({...rentalForm, week_end: e.target.value})} style={{width:"100%", padding:"8px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}} /></div>
                </div>
                <div style={{fontSize:11, color:C.textDim, marginBottom:8, fontStyle:'italic'}}>Select a therapist to auto-populate locations and session counts from calendar data.</div>
                {rentalSessionsLoading && <div style={{padding:'8px 12px', marginBottom:8, borderRadius:6, background:'#1E3A5F', color:'#60A5FA', fontSize:11}}>Loading session data...</div>}
                <div style={{fontSize:12, fontWeight:700, color:C.textMuted, marginBottom:8, textTransform:"uppercase", letterSpacing:0.5}}>Therapist Entries</div>
                {rentalForm.entries.map((entry, idx) => (
                  <div key={idx} style={{display:"grid", gridTemplateColumns:"2fr 1fr 0.8fr 1fr 1fr 1fr auto", gap:8, marginBottom:8, alignItems:"end"}}>
                    <div><label style={{fontSize:10, color:C.textDim, display:"block", marginBottom:2}}>Therapist</label><select value={entry.therapist} onChange={e => handleTherapistSelect(idx, e.target.value)} style={{width:"100%", padding:"7px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}}><option value="">Select therapist...</option>{RENTAL_THERAPISTS.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                    <div><label style={{fontSize:10, color:C.textDim, display:"block", marginBottom:2}}>Location</label><select value={entry.location} onChange={e => updateRentalRow(idx, 'location', e.target.value)} style={{width:"100%", padding:"7px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}}>{RENTAL_LOCATIONS.map(l => <option key={l} value={l}>{l}</option>)}</select></div>
                    <div><label style={{fontSize:10, color:C.textDim, display:'block', marginBottom:2}}>Sessions</label><input type="number" value={entry.sessions} onChange={e => updateRentalRow(idx, 'sessions', e.target.value)} style={{width:'100%', padding:'6px 8px', background:C.card, border:'1px solid ' + C.border, borderRadius:6, color:'#4ADE80', fontSize:13, fontWeight:600}} placeholder="0" /></div>
                    <div><label style={{fontSize:10, color:C.textDim, display:"block", marginBottom:2}}>Room Rental ($)</label><input type="number" step="0.01" value={entry.amount_room} onChange={e => updateRentalRow(idx, 'amount_room', e.target.value)} placeholder="0.00" style={{width:"100%", padding:"7px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}} /></div>
                    <div><label style={{fontSize:10, color:C.textDim, display:"block", marginBottom:2}}>Marketing ($)</label><input type="number" step="0.01" value={entry.amount_mkt} onChange={e => updateRentalRow(idx, 'amount_mkt', e.target.value)} placeholder="0.00" style={{width:"100%", padding:"7px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}} /></div>
                    <div><label style={{fontSize:10, color:C.textDim, display:"block", marginBottom:2}}>Testing ($)</label><input type="number" step="0.01" value={entry.amount_test} onChange={e => updateRentalRow(idx, 'amount_test', e.target.value)} placeholder="0.00" style={{width:"100%", padding:"7px 10px", background:"#1a1a2e", border:"1px solid #2a2a4a", borderRadius:6, color:C.text, fontSize:13}} /></div>
                    <button onClick={() => removeRentalRow(idx)} style={{background:"transparent", border:"1px solid #E85D7540", color:C.rose, cursor:"pointer", fontSize:16, padding:"6px 10px", borderRadius:6, marginBottom:2, lineHeight:1, display:"flex", alignItems:"center", justifyContent:"center"}} title="Remove row">√ó</button>
                  </div>
                ))}
                <div style={{display:"flex", gap:12, marginTop:12}}>
                  <button onClick={addRentalRow} style={{padding:"8px 20px", background:"transparent", border:"1px solid " + C.accent + "40", borderRadius:8, color:C.accent, fontWeight:600, cursor:"pointer", fontSize:13}}>+ Add Row</button>
                  <button onClick={submitRental} style={{padding:"8px 24px", background: editingRentalWeek ? "#F59E0B" : C.accent, color:"#0B0E11", border:"none", borderRadius:8, fontWeight:700, fontSize:14, cursor:"pointer"}}>{editingRentalWeek ? "Update Week" : "Submit Week"}</button>
                  {editingRentalWeek && <button onClick={() => { setEditingRentalWeek(null); const autoWeek = getAutoWeekDates(); setRentalForm({week_start: autoWeek.week_start, week_end: autoWeek.week_end, entries:[{therapist:'', location:'FTL', amount_room:'', amount_mkt:'', amount_test:'', notes:''}]}); setRentalMsg(null); }} style={{padding:"8px 20px", background:"transparent", color:C.textMuted, border:"1px solid #2a2a4a", borderRadius:8, fontWeight:600, cursor:"pointer", fontSize:13}}>Cancel Edit</button>}
                </div>
              </ChartCard>

              {rentalForm.week_start && rentalForm.week_end && (
                <ChartCard title={"Entries for " + rentalForm.week_start + " ‚Äî " + rentalForm.week_end} style={{marginTop:16}}>
                  <button onClick={() => loadRentalWeek(rentalForm.week_start, rentalForm.week_end)} style={{padding:"6px 16px", background:C.accent, color:"#0B0E11", border:"none", borderRadius:6, fontWeight:600, cursor:"pointer", fontSize:12, marginBottom:12}}>Load Entries</button>
                  {rentalLoadingEntries ? <div style={{color:C.textMuted, padding:16, textAlign:"center"}}>Loading...</div>
                  : rentalWeekEntries.length === 0 ? <div style={{color:C.textMuted, padding:16, textAlign:"center"}}>No entries for this week yet</div>
                  : <div style={{overflowX:"auto"}}>
                      <table style={{width:"100%", borderCollapse:"collapse", fontSize:12}}>
                        <thead><tr style={{borderBottom:"1px solid #2a2a4a"}}>
                          <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Therapist</th>
                          <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Location</th>
                          <th style={{padding:"8px 6px", textAlign:"right", color:C.textMuted, fontWeight:600}}>Amount</th>
                          <th style={{padding:"8px 6px", textAlign:"left", color:C.textMuted, fontWeight:600}}>Category</th>
                        </tr></thead>
                        <tbody>{rentalWeekEntries.map(ent => (
                          <tr key={ent.id} style={{borderBottom:"1px solid #1a1a2e"}}>
                            <td style={{padding:"8px 6px", color:C.text, fontWeight:600}}>{ent.therapist}</td>
                            <td style={{padding:"8px 6px", color:C.textMuted}}>{ent.location}</td>
                            <td style={{padding:"8px 6px", textAlign:"right", color:C.accent, fontWeight:700}}>{"$" + parseFloat(ent.amount).toLocaleString()}</td>
                            <td style={{padding:"8px 6px", color:C.textMuted}}>{ent.category}</td>
                          </tr>
                        ))}</tbody>
                      </table>
                      <div style={{marginTop:12}}>
                        <button onClick={() => loadWeekForEdit(rentalForm.week_start, rentalForm.week_end)} style={{padding:"6px 16px", background:"#F59E0B", color:"#0B0E11", border:"none", borderRadius:6, fontWeight:600, cursor:"pointer", fontSize:12}}>Edit This Week</button>
                      </div>
                    </div>
                  }
                </ChartCard>
              )}
            </div>
          )}

          {activeTab === "sessions" && (
          <div className="animate-in">
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 24 }}>
              <h2 style={{ fontSize: 22, fontWeight: 700, color: C.text }}>Weekly Session Counts by Therapist</h2>
              <button onClick={() => {
                setSessionsLoading(true);
                fetch("/api/sessions?weeks=12")
                  .then(r => r.json())
                  .then(data => { setSessionsData(data); setSessionsLoading(false); })
                  .catch(() => setSessionsLoading(false));
              }} style={{ padding: "8px 20px", background: C.accent, color: "#0B0E11", border: "none", borderRadius: 8, fontWeight: 600, cursor: "pointer", fontSize: 14 }}>
                Refresh
              </button>
            </div>

            {sessionsLoading && <div style={{ textAlign: "center", padding: 40, color: C.muted }}>Loading session data from calendars...</div>}

            {!sessionsLoading && sessionsData && sessionsData.weeks && (
              <div>
                {/* Week selector */}
                <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 20 }}>
                  {sessionsData.weeks.map((w, idx) => (
                    <button key={idx} onClick={() => setSessionsWeekIdx(idx)}
                      style={{
                        padding: "8px 16px", borderRadius: 8, border: "none", cursor: "pointer",
                        background: sessionsWeekIdx === idx ? C.accent : C.card,
                        color: sessionsWeekIdx === idx ? "#0B0E11" : C.text,
                        fontWeight: sessionsWeekIdx === idx ? 700 : 400,
                        fontSize: 13, transition: "all 0.2s",
                        outline: w.is_current ? ("2px solid " + C.accent) : "none",
                        outlineOffset: 2,
                      }}>
                      {w.week_label}{w.is_current ? " (Current)" : ""}
                    </button>
                  ))}
                </div>

                {/* Selected week data */}
                {sessionsWeekIdx !== null && sessionsData.weeks[sessionsWeekIdx] && (() => {
                  const week = sessionsData.weeks[sessionsWeekIdx];
                  const locations = Object.keys(week.locations);
                  return (
                    <div>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
                        <h3 style={{ fontSize: 18, fontWeight: 600, color: C.text }}>Week of {week.week_label}</h3>
                        <div style={{ background: C.accent, color: "#0B0E11", padding: "6px 16px", borderRadius: 20, fontWeight: 700, fontSize: 15 }}>
                          Total: {week.grand_total} sessions
                        </div>
                      </div>
                    {/* Week Selected Summary ‚Äî therapist totals across all locations for selected week */}
                    {(() => {
                      const therapistMap = {};
                      Object.keys(week.locations).forEach(loc => {
                        const locData = week.locations[loc];
                        locData.rows.forEach(row => {
                          if (!therapistMap[row.therapist]) {
                            therapistMap[row.therapist] = { therapist: row.therapist, total: 0, by_location: {} };
                          }
                          therapistMap[row.therapist].total += row.total;
                          therapistMap[row.therapist].by_location[loc] = (therapistMap[row.therapist].by_location[loc] || 0) + row.total;
                        });
                      });
                      const weekSummary = Object.values(therapistMap).sort((a, b) => b.total - a.total);
                      const weekLocations = Object.keys(week.locations);
                      if (weekSummary.length === 0) return null;
                      return (
                        <ChartCard title={"Week Summary ‚Äî " + week.week_label} style={{ marginBottom: 16 }}>
                          <div style={{ overflowX: "auto" }}>
                            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 14 }}>
                              <thead>
                                <tr style={{ borderBottom: "1px solid " + C.border }}>
                                  <th style={{ textAlign: "left", padding: "10px 12px", color: C.muted, fontWeight: 600 }}>Therapist</th>
                                  {weekLocations.map(loc => <th key={loc} style={{ textAlign: "center", padding: "10px 8px", color: C.muted, fontWeight: 600 }}>{loc}</th>)}
                                  <th style={{ textAlign: "center", padding: "10px 12px", color: C.accent, fontWeight: 700 }}>Total</th>
                                </tr>
                              </thead>
                              <tbody>
                                {weekSummary.map((t, i) => (
                                  <tr key={i} style={{ borderBottom: "1px solid " + C.border + "40" }}>
                                    <td style={{ padding: "10px 12px", fontWeight: 600, color: C.text }}>{t.therapist}</td>
                                    {weekLocations.map(loc => <td key={loc} style={{ textAlign: "center", padding: "10px 8px", color: t.by_location[loc] ? C.text : C.muted + "60" }}>{t.by_location[loc] || "\u2013"}</td>)}
                                    <td style={{ textAlign: "center", padding: "10px 12px", fontWeight: 700, color: C.accent }}>{t.total}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </ChartCard>
                      );
                    })()}

                      {locations.length === 0 && <div style={{ textAlign: "center", padding: 40, color: C.muted }}>No sessions found for this week.</div>}
                      {locations.map(loc => {
                        const locData = week.locations[loc];
                        const eKey = loc + "_" + sessionsWeekIdx;
                        const isExpanded = sessionsExpanded[eKey] !== false;
                        return (
                          <ChartCard key={loc} title={loc + " (" + locData.location_total + " sessions)"}>
                            <div style={{ cursor: "pointer", marginBottom: 8 }} onClick={() => setSessionsExpanded(prev => ({...prev, [eKey]: !isExpanded}))}>
                              <span style={{ color: C.muted, fontSize: 13 }}>{isExpanded ? "\u25BC" : "\u25B6"} {isExpanded ? "Hide" : "Show"} details</span>
                            </div>
                            {isExpanded && (
                              <div style={{ overflowX: "auto" }}>
                                <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 14 }}>
                                  <thead>
                                    <tr style={{ borderBottom: "1px solid " + C.border }}>
                                      <th style={{ textAlign: "left", padding: "10px 12px", color: C.muted, fontWeight: 600 }}>Therapist</th>
                                      {["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(d => <th key={d} style={{ textAlign: "center", padding: "10px 8px", color: C.muted, fontWeight: 600, minWidth: 45 }}>{d}</th>)}
                                      <th style={{ textAlign: "center", padding: "10px 12px", color: C.accent, fontWeight: 700, minWidth: 55 }}>Total</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {locData.rows.map((row, ri) => (
                                      <tr key={ri} style={{ borderBottom: "1px solid " + C.border + "40" }}>
                                        <td style={{ padding: "10px 12px", fontWeight: 600, color: C.text }}>{row.therapist}</td>
                                        {["mon","tue","wed","thu","fri","sat","sun"].map(day => (
                                          <td key={day} style={{ textAlign: "center", padding: "10px 8px", color: row[day] > 0 ? C.text : C.muted + "60" }}>{row[day] > 0 ? row[day] : "-"}</td>
                                        ))}
                                        <td style={{ textAlign: "center", padding: "10px 12px", fontWeight: 700, color: C.accent }}>{row.total}</td>
                                      </tr>
                                    ))}
                                    <tr style={{ borderTop: "2px solid " + C.border }}>
                                      <td style={{ padding: "10px 12px", fontWeight: 700, color: C.text }}>Location Total</td>
                                      {["mon","tue","wed","thu","fri","sat","sun"].map(day => {
                                        const dt = locData.rows.reduce((s, r) => s + r[day], 0);
                                        return <td key={day} style={{ textAlign: "center", padding: "10px 8px", fontWeight: 600, color: dt > 0 ? C.text : C.muted }}>{dt > 0 ? dt : "-"}</td>;
                                      })}
                                      <td style={{ textAlign: "center", padding: "10px 12px", fontWeight: 700, color: C.accent, fontSize: 16 }}>{locData.location_total}</td>
                                    </tr>
                                  </tbody>
                                </table>
                              </div>
                            )}
                          </ChartCard>
                        );
                      })}
                    </div>
                  );
                })()}

              </div>
            )}

            {!sessionsLoading && !sessionsData && (
              <div style={{ textAlign: "center", padding: 40, color: C.muted }}>No session data available. Click Refresh to load.</div>
            )}
          </div>
        )}


        {/* ‚ïê‚ïê‚ïê ROOM RENTAL TAB ‚ïê‚ïê‚ïê */}
        {activeTab === "rental" && (() => {
          const R = PRECOMPUTED._rental || {};
            const periods = { ytd: R.ytd, lastYear: R.lastYear, allTime: R.allTime, thisMonth: R.thisMonth, lastMonth: R.lastMonth };
            const rentalPeriodMap = { ytd: "ytd", month: "thisMonth", week: "thisMonth", today: "thisMonth", all: "allTime", lastyear: "lastYear" };
            const rentalPeriod = rentalPeriodMap[timeFilter] || "ytd";
          const rp = periods[rentalPeriod] || R.allTime || {};
          const rpTherapists = rentalPeriod === "ytd" ? R.ytdTherapists : rentalPeriod === "lastYear" ? R.lyTherapists : rentalPeriod === "thisMonth" ? R.thisMonthTherapists : R.therapists;
          const prevPeriod = rentalPeriod === "ytd" ? R.prevYtd : rentalPeriod === "thisMonth" ? R.lastMonth : rentalPeriod === "lastYear" ? R.prevLy : null;
          const rpLabel = rentalPeriod === "ytd" ? "vs same period last year" : rentalPeriod === "thisMonth" ? "vs last month" : rentalPeriod === "lastYear" ? "vs prior year" : "";

          // Location pie data
          const locData = [
            { name: "Fort Lauderdale", value: rp.ftl || 0 },
            { name: "Coral Springs", value: rp.cs || 0 },
            { name: "Plantation", value: rp.pl || 0 },
          ].filter(l => l.value > 0);

          // Revenue mix data
          const mixData = [
            { name: "Room Rental", value: (rp.gt || 0) - (rp.mkt || 0) - (rp.testing || 0) },
            { name: "Marketing", value: rp.mkt || 0 },
            { name: "Testing", value: rp.testing || 0 },
          ].filter(d => d.value > 0);


          return (
          <>

            {/* KPIs */}
            <div style={{ display: "grid", gridTemplateColumns: "repeat(6, 1fr)", gap: 16, marginBottom: 24 }}>
              <StatCard label="Total Revenue" value={fmtCurrency(rp.gt || 0)} icon="üí∞" color={C.accent} sub={`${rp.weeks || 0} weeks`} prev={prevPeriod?.gt} prevLabel={rpLabel} />
              <StatCard label="Fort Lauderdale" value={fmtCurrency(rp.ftl || 0)} icon="üè¢" color={C.blue} sub={rp.gt ? `${Math.round((rp.ftl||0)/rp.gt*100)}% of total` : ""} prev={prevPeriod?.ftl} prevLabel={rpLabel} />
              <StatCard label="Coral Springs" value={fmtCurrency(rp.cs || 0)} icon="üè¢" color={C.warm} sub={rp.gt ? `${Math.round((rp.cs||0)/rp.gt*100)}% of total` : ""} prev={prevPeriod?.cs} prevLabel={rpLabel} />
              <StatCard label="Plantation" value={fmtCurrency(rp.pl || 0)} icon="üè¢" color={C.purple} sub={rp.gt ? `${Math.round((rp.pl||0)/rp.gt*100)}% of total` : ""} prev={prevPeriod?.pl} prevLabel={rpLabel} />
              <StatCard label="Testing Revenue" value={fmtCurrency(rp.testing || 0)} icon="üß™" color={C.rose} sub={rp.gt ? `${Math.round((rp.testing||0)/rp.gt*100)}% of total` : ""} prev={prevPeriod?.testing} prevLabel={rpLabel} />
              <StatCard label="Avg per Week" value={fmtCurrency(rp.avgWeek || 0)} icon="üìà" color="#8b5cf6" sub={`Marketing: ${fmtCurrency(rp.mkt||0)}`} prev={prevPeriod?.avgWeek} prevLabel={rpLabel} />
            </div>

            {/* Weekly Revenue Chart */}
            <ChartCard title="Weekly Room Rental Revenue" subtitle="Last 52 weeks ‚Äî revenue by location" style={{ marginBottom: 16 }}>
              <ResponsiveContainer width="100%" height={320}>
                <BarChart data={R.weekly52 || R.weekly || []}>
                  <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
                  <XAxis dataKey="week" tick={{ fontSize: 8, fill: C.textMuted }} axisLine={false} tickLine={false} tickFormatter={d => { const dt = new Date(d + 'T00:00:00'); return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }} interval={3} />
                  <YAxis tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} tickFormatter={v => `$${(v/1000).toFixed(0)}k`} />
                  <Tooltip content={<Tip />} formatter={(v) => `$${v.toLocaleString()}`} labelFormatter={d => { const dt = new Date(d + 'T00:00:00'); return `Week of ${dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`; }} />
                  <Legend wrapperStyle={{ fontSize: 11 }} />
                  <Bar dataKey="ftl" name="Fort Lauderdale" fill={C.blue} stackId="loc" barSize={10} />
                  <Bar dataKey="cs" name="Coral Springs" fill={C.warm} stackId="loc" barSize={10} />
                  <Bar dataKey="pl" name="Plantation" fill={C.purple} stackId="loc" barSize={10} radius={[2, 2, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </ChartCard>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 16 }}>
              {/* Location Breakdown Pie */}
              <ChartCard title="Revenue by Location" subtitle="Distribution across offices">
                <ResponsiveContainer width="100%" height={280}>
                  <PieChart>
                    <Pie data={locData} dataKey="value" nameKey="name" cx="50%" cy="50%" innerRadius={55} outerRadius={95} paddingAngle={3} label={({ name, value }) => `${name.split(' ')[0]} ($${(value/1000).toFixed(0)}k)`} labelLine={{ stroke: C.textDim }} style={{ fontSize: 10 }}>
                      {locData.map((_, i) => <Cell key={i} fill={[C.blue, C.warm, C.purple][i]} />)}
                    </Pie>
                    <Tooltip formatter={(v) => `$${v.toLocaleString()}`} />
                  </PieChart>
                </ResponsiveContainer>
              </ChartCard>

              {/* Revenue Mix */}
              <ChartCard title="Revenue Mix" subtitle="Room rental vs marketing vs testing">
                <ResponsiveContainer width="100%" height={280}>
                  <PieChart>
                    <Pie data={mixData} dataKey="value" nameKey="name" cx="50%" cy="50%" innerRadius={55} outerRadius={95} paddingAngle={3} label={({ name, value }) => `${name} ($${(value/1000).toFixed(0)}k)`} labelLine={{ stroke: C.textDim }} style={{ fontSize: 10 }}>
                      {mixData.map((_, i) => <Cell key={i} fill={[C.accent, C.warm, C.rose][i]} />)}
                    </Pie>
                    <Tooltip formatter={(v) => `$${v.toLocaleString()}`} />
                  </PieChart>
                </ResponsiveContainer>
              </ChartCard>
            </div>

            {/* Monthly Revenue Trend with Prior Year */}
            <ChartCard title="üìä Monthly Revenue Trend" subtitle="Current period vs prior year ‚Äî dashed line shows same month one year ago" style={{ marginBottom: 16 }}>
              <ResponsiveContainer width="100%" height={280}>
                <ComposedChart data={(() => { const all = R.monthly || []; const dict = {}; all.forEach(m => { dict[m.month] = m.gt; }); return all.slice(-24).map(m => { const [yr, mo] = m.month.split('-'); const prevKey = `${parseInt(yr)-1}-${mo}`; return { ...m, priorYear: dict[prevKey] || null }; }); })()}>
                  <defs>
                    <linearGradient id="gRental" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={C.accent} stopOpacity={0.3} /><stop offset="100%" stopColor={C.accent} stopOpacity={0.02} /></linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
                  <XAxis dataKey="month" tick={{ fontSize: 9, fill: C.textMuted }} axisLine={false} tickLine={false} tickFormatter={fmtMonth} />
                  <YAxis tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} tickFormatter={v => `$${(v/1000).toFixed(0)}k`} />
                  <Tooltip content={<Tip />} formatter={(v, name) => [`$${v.toLocaleString()}`, name]} labelFormatter={fmtMonth} />
                  <Legend wrapperStyle={{ fontSize: 11 }} />
                  <Area type="monotone" dataKey="gt" name="Current Revenue" stroke={C.accent} fill="url(#gRental)" strokeWidth={2} />
                  <Line type="monotone" dataKey="priorYear" name="Prior Year" stroke={C.textMuted} strokeWidth={1.5} strokeDasharray="6 3" dot={false} connectNulls={false} />
                </ComposedChart>
              </ResponsiveContainer>
            </ChartCard>

            {/* Year over Year */}
            {(R.yearly || []).length > 1 && (
              <ChartCard title="üìà Year-over-Year Revenue" subtitle="Annual room rental revenue by location" style={{ marginBottom: 16 }}>
                <ResponsiveContainer width="100%" height={280}>
                  <BarChart data={R.yearly || []}>
                    <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
                    <XAxis dataKey="year" tick={{ fontSize: 11, fill: C.textMuted }} axisLine={false} tickLine={false} />
                    <YAxis tick={{ fontSize: 10, fill: C.textMuted }} axisLine={false} tickLine={false} tickFormatter={v => `$${(v/1000).toFixed(0)}k`} />
                    <Tooltip content={<Tip />} formatter={(v) => `$${v.toLocaleString()}`} />
                    <Legend wrapperStyle={{ fontSize: 11 }} />
                    <Bar dataKey="ftl" name="Fort Lauderdale" fill={C.blue} radius={[4, 4, 0, 0]} barSize={24} />
                    <Bar dataKey="cs" name="Coral Springs" fill={C.warm} radius={[4, 4, 0, 0]} barSize={24} />
                    <Bar dataKey="pl" name="Plantation" fill={C.purple} radius={[4, 4, 0, 0]} barSize={24} />
                  </BarChart>
                </ResponsiveContainer>
              </ChartCard>
            )}

            {/* Top Therapists */}
            <ChartCard title="üèÜ Top Therapists by Room Rental Revenue" subtitle={`${rentalPeriod === "ytd" ? "YTD" : rentalPeriod === "thisMonth" ? "This Month" : rentalPeriod === "lastYear" ? "Last Year" : "All Time"} ‚Äî sorted by total revenue`}>
              <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(260px, 1fr))", gap: 10, marginTop: 8 }}>
                {(rpTherapists || []).slice(0, 24).map((t, i) => {
                  const maxVal = (rpTherapists || [])[0]?.total || 1;
                  const pct = Math.round(t.total / maxVal * 100);
                  const locColor = t.loc === 'FTL' ? C.blue : t.loc === 'CS' ? C.warm : C.purple;
                  return (
                    <div key={t.col} style={{ background: C.bg, border: `1px solid ${C.border}`, borderRadius: 10, padding: "12px 14px", position: "relative", overflow: "hidden" }}>
                      <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 3, background: locColor, opacity: 0.6 }} />
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                          <span style={{ fontSize: 11, fontWeight: 800, color: i < 3 ? "#FFD700" : C.textMuted, width: 18, textAlign: "center" }}>#{i + 1}</span>
                          <span style={{ fontSize: 13, fontWeight: 700, color: C.text }}>{t.name}</span>
                        </div>
                        <span style={{ fontSize: 10, padding: "1px 6px", borderRadius: 4, background: `${locColor}20`, color: locColor, fontWeight: 600 }}>{t.loc}</span>
                      </div>
                      <div style={{ fontSize: 18, fontWeight: 800, color: C.accent, marginBottom: 6 }}>{fmtCurrency(t.total)}</div>
                      <div style={{ height: 4, background: C.border, borderRadius: 2, overflow: "hidden" }}>
                        <div style={{ height: "100%", width: `${pct}%`, background: locColor, borderRadius: 2, transition: "width 0.3s" }} />
                      </div>
                    </div>
                  );
                })}
              </div>
            </ChartCard>
          
              
              </>
          );
        })()}

      </div>

      {/* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */}
      <div style={{ borderTop: `1px solid ${C.border}`, padding: "14px 28px", display: "flex", justifyContent: "space-between", fontSize: 11, color: C.textDim }}>
        <span>Bayview Lead Intelligence Dashboard ‚Ä¢ Data synced from Google Forms intake</span>
        <span>{stats.total.toLocaleString()} total leads ‚Ä¢ {stats.team.length} team members ‚Ä¢ {stats.locations.length} locations</span>
      </div>
    </div>
  );
}


    // ‚îÄ‚îÄ‚îÄ App wrapper with data fetching ‚îÄ‚îÄ‚îÄ
    function App() {
      const [data, setData] = useState(null);
      const [error, setError] = useState(null);
      const [lastRefresh, setLastRefresh] = useState(null);

      const loadData = () => {
        setError(null);
        fetch("/api/data")
          .then(r => {
            if (!r.ok) throw new Error("Server returned " + r.status);
            setLastRefresh(r.headers.get("X-Last-Refresh"));
            return r.json();
          })
          .then(d => { PRECOMPUTED = d; setData(d); })
          .catch(e => setError(e.message));
      };

      useEffect(() => {
        loadData();
        // Auto-refresh every 5 minutes in the browser
        const interval = setInterval(loadData, 5 * 60 * 1000);
        return () => clearInterval(interval);
      }, []);

      if (error) {
        return (
          <div id="loading">
            <div className="error-box">
              <h2>‚ö†Ô∏è Connection Error</h2>
              <p>{error}</p>
              <button onClick={loadData}>Retry</button>
            </div>
          </div>
        );
      }

      if (!data) {
        return (
          <div id="loading">
            <div className="spinner"></div>
            <div className="load-text">Loading dashboard data from Google Sheets‚Ä¶</div>
          </div>
        );
      }

      return <BayviewDashboard />;
    }

    // ‚îÄ‚îÄ‚îÄ Mount ‚îÄ‚îÄ‚îÄ
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
